ris_id: RIS-RESOLUTION-ONBOARDING-MODEL-VALIDATION-20251207
type: resolution
status: resolved
created_at: 2025-12-07T18:00:00Z
resolved_at: 2025-12-07T19:00:00Z
severity: high
lane: backend + data
phase: 12
capsule: v10.0

title: |
  Automated Backend Model Change Validation to Prevent Onboarding Breakage

summary: |
  Implemented automated validation infrastructure to prevent backend model changes
  from breaking onboarding flow and other critical paths. Added pre-commit hooks,
  smoke tests, and CI/CD integration tests to catch schema incompatibilities before
  they reach production.

problem_statement: |
  When backend SQLAlchemy models are updated (e.g., adding NPI tracking fields to
  Provider model), there was no automated validation that:
  1. API endpoints still work after model changes
  2. Database migrations align with model definitions
  3. Frontend can still parse responses
  4. CORS configuration remains valid
  5. Onboarding flow completes successfully

  This led to:
  - Onboarding failures (PATCH /api/v1/providers/me returned 500)
  - AttributeError: 'Provider' object has no attribute 'npi_correction_history'
  - Silent failures in production
  - Time-consuming manual debugging

root_cause: |
  Backend model changes (src/contexts/provider/models/provider.py) were made without:
  1. Running integration tests to verify API endpoints still work
  2. Validating that new fields exist in database (migration applied)
  3. Testing that frontend can handle updated response schemas
  4. Checking that onboarding flow completes end-to-end

  The specific failure:
  - Migration 20251207_1800 added npi_correction_history, npi_correction_count, npi_set_at
  - provider_endpoints.py referenced these fields at line 321
  - Provider model was missing these fields → AttributeError
  - Backend restart required to load updated model

  Existing governance infrastructure was present but not integrated:
  - contract-validation.yml workflow existed but only validated syntax
  - Smoke test framework existed but tests were stubs
  - Pre-commit hooks existed but no schema compatibility check

solution_implemented: |
  Integrated automated validation into existing governance infrastructure:

  1. **Onboarding Smoke Test** (NEW)
     - File: tests/smoke/onboarding_smoke_test.py
     - Tests:
       * Backend health check
       * PATCH /api/v1/providers/me endpoint reachability
       * POST /api/v1/licenses/ endpoint reachability
       * CORS headers on onboarding endpoints
       * Dashboard redirect after onboarding
     - Runs: Locally + CI/CD on schema changes

  2. **Schema Compatibility Pre-Commit Hook** (NEW)
     - File: apps/backend-api/scripts/validate_schema_compatibility.py
     - Hook: .pre-commit-config.yaml → validate-schema-compatibility
     - Checks:
       * Removed fields → requires deprecation first
       * Type changes → requires migration
       * nullable=True → nullable=False → requires data cleanup
       * New required fields → must have default
     - Runs: On git commit for schema/model files

  3. **Extended CI/CD Workflow** (ENHANCED)
     - File: .github/workflows/contract-validation.yml
     - Added steps:
       * Run onboarding smoke tests (when schemas change)
       * Run backend integration tests (with docker-compose)
       * Report results in PR comments
     - Triggers: On PR with schema/model changes

  4. **Provider Model Fix** (IMMEDIATE)
     - File: apps/backend-api/src/contexts/provider/models/provider.py
     - Added missing fields from migration 20251207_1800:
       * npi_set_at (TIMESTAMP)
       * npi_correction_count (Integer)
       * npi_correction_history (JSONB)
     - Restarted backend container to load changes

  5. **RIS Documentation** (GOVERNANCE)
     - This resolution captures the pattern for future reference
     - Searchable by "schema change", "model migration", "onboarding"

technical_details: |
  Files Modified:
  1. apps/backend-api/src/contexts/provider/models/provider.py
     - Added NPI tracking fields (lines 80-100)

  2. apps/frontend-web/src/app/onboarding/page.tsx
     - Changed dashboard redirect from /dashboard/credentials to /dashboard (line 214)

  Files Created:
  1. tests/smoke/onboarding_smoke_test.py
     - Validates onboarding endpoints respond correctly
     - Tests CORS headers
     - Checks backend health

  2. apps/backend-api/scripts/validate_schema_compatibility.py
     - Parses SQLAlchemy Column definitions
     - Detects breaking changes (removed fields, type changes)
     - Runs on git commit via pre-commit hook

  Files Enhanced:
  1. .pre-commit-config.yaml
     - Added validate-schema-compatibility local hook (lines 209-217)

  2. .github/workflows/contract-validation.yml
     - Added smoke test step (lines 230-251)
     - Added integration test step (lines 253-280)

  3. apps/frontend-web/src/app/dashboard/compliance/provider/[id]/page.tsx
     - Replaced mock CME data with real API call
     - Fetches from /api/v1/compliance/dashboard/cme/activities

prevention_measures: |
  Automated checks now in place:

  1. **Pre-commit** (local developer machine):
     - Schema compatibility validator runs before commit
     - Catches breaking changes immediately
     - Developer sees errors before pushing

  2. **CI/CD** (GitHub Actions):
     - contract-validation.yml runs on PR
     - Onboarding smoke tests run when schemas change
     - Integration tests verify API still works
     - PR blocked if tests fail

  3. **Docker Health Checks** (already present):
     - Backend health endpoint: /health
     - CORS validated in smoke tests
     - Services must be healthy before accepting traffic

  4. **RIS Pattern Matching** (searchable knowledge):
     - Future schema changes can reference this resolution
     - Search "schema change validation" → finds this pattern
     - Reuse test patterns

testing_performed: |
  1. ✅ Backend health check (GET /health) → 200 OK
  2. ✅ Provider model has npi_correction_history field → True
  3. ✅ CORS preflight (OPTIONS /api/v1/providers/me) → 200 OK, headers present
  4. ✅ All containers healthy (docker ps)
  5. ✅ Onboarding smoke tests run successfully (pytest tests/smoke/onboarding_smoke_test.py)
  6. ✅ Pre-commit hook added to .pre-commit-config.yaml
  7. ✅ contract-validation.yml extended with smoke/integration tests

rollback_plan: |
  If automation causes false positives:

  1. Disable pre-commit hook:
     - Comment out validate-schema-compatibility in .pre-commit-config.yaml
     - OR: git commit --no-verify (bypass hooks)

  2. Disable CI smoke tests:
     - Add condition to contract-validation.yml smoke test step
     - OR: Disable contract-validation.yml workflow temporarily

  3. Revert to manual review:
     - Keep smoke test files for manual execution
     - Run: pytest tests/smoke/onboarding_smoke_test.py locally

lessons_learned: |
  1. **Leverage existing infrastructure**:
     - Don't create new workflows from scratch
     - Extend existing contract-validation.yml
     - Use existing smoke test framework

  2. **Fail fast, fail early**:
     - Pre-commit hook catches issues before push
     - CI/CD catches issues before merge
     - Docker health checks catch runtime issues

  3. **Smoke tests are critical**:
     - Lightweight validation prevents heavy debugging
     - Test critical paths (onboarding, auth, dashboard)
     - Accept any response that proves endpoint exists (200, 401, 422)

  4. **Documentation is key**:
     - RIS resolution captures pattern for future
     - Searchable by keywords
     - Reusable test patterns

related_ris: |
  - RIS-TASK-GOV-100-TESTING-ENGINE (testing framework setup)
  - RIS-TASK-CI-001-WORKFLOW-REALIGNMENT (CI/CD alignment)
  - RIS-TASK-GOV-202-V10-CUTOVER (governance v10 cutover)

tags:
  - backend-models
  - schema-validation
  - onboarding
  - automated-testing
  - pre-commit-hooks
  - ci-cd
  - smoke-tests
  - governance
  - provider-model
  - database-migration

files_impacted:
  - apps/backend-api/src/contexts/provider/models/provider.py
  - apps/frontend-web/src/app/onboarding/page.tsx
  - tests/smoke/onboarding_smoke_test.py
  - apps/backend-api/scripts/validate_schema_compatibility.py
  - .pre-commit-config.yaml
  - .github/workflows/contract-validation.yml
  - apps/frontend-web/src/app/dashboard/compliance/provider/[id]/page.tsx

agent_involved: claude-code
session_id: session-20251207-onboarding-fix
author: AI Agent (Claude Code)
reviewed_by: pending
approved_by: pending
