id: RIS-RESOLUTION-072
type: resolution
status: resolved
created: 2025-12-15
resolved: 2025-12-15
severity: high
category: governance

title: "Post-Mortem Preventive Controls - Config Drift & Migration Safety"

problem: |
  Dec 15, 2025 deployment took 3 hours instead of 15-20 minutes due to:
  1. Config drift: EC2 had ALLOWED_ORIGINS instead of CORS_ALLOWED_ORIGINS (45 min lost)
  2. Migration failure: CHECK constraint failed on 66 existing rows (20 min lost)
  Total avoidable time: 65 minutes out of 180 minutes (36% wasted)

  Root causes:
  - No config drift detection between EC2 and repo
  - No pre-migration data validation pattern enforcement
  - Manual deployment had no validation gates

incident_reference: "SESSION-20251215-MANUAL-DEPLOYMENT-POSTMORTEM.md"

solution: |
  Implemented 2 BLOCKING governance controls:

  1. Config Drift Detector (260 lines)
     - File: infra/scripts/check_config_drift.py
     - Compares EC2 vs repo docker-compose.yml via AWS SSM
     - Checks critical sections: CORS_ALLOWED_ORIGINS, image refs, env vars
     - Handles Windows UTF-16LE encoding
     - Exit codes: 0=no drift, 1=drift (BLOCKING), 2=SSM error
     - Integrated into deploy-direct.sh at step 3.5 (BLOCKS deployment)

  2. Migration Constraint Linter (160 lines)
     - File: infra/scripts/validate_migration_constraints.py
     - Enforces "validate → fix → constrain" pattern
     - Detects CHECK/NOT NULL/UNIQUE constraint additions
     - Verifies SELECT and UPDATE queries exist BEFORE constraint
     - Pre-commit hook BLOCKS commits without pattern
     - Allows exemption via comment: # MIGRATION_CONSTRAINT_EXEMPT: reason

  Additional work:
  - Fixed existing 20251214_2115 migration with validate→fix→constrain pattern
  - Created migration_constraint_pattern.md documentation
  - Added 2 CRITICAL policies to CLAUDE.md

implementation:
  phases:
    - name: "Analysis & Planning"
      duration: 60 minutes
      deliverables:
        - Read post-mortem SESSION-20251215-MANUAL-DEPLOYMENT-POSTMORTEM.md
        - Launched 2 Plan agents for solution design
        - Created comprehensive implementation plan
        - Adjusted for direct EC2 deployments only (no GHA)

    - name: "Config Drift Detector"
      duration: 90 minutes
      deliverables:
        - Created check_config_drift.py (260 lines)
        - Added SSM-based EC2 config extraction
        - Implemented critical section comparison logic
        - Integrated into deploy-direct.sh at step 3.5 (BLOCKING)
        - Added Configuration Drift Policy to CLAUDE.md

    - name: "Migration Constraint Linter"
      duration: 60 minutes
      deliverables:
        - Created validate_migration_constraints.py (160 lines)
        - Implemented AST-based constraint detection
        - Added pre-commit hook registration
        - Fixed existing 20251214_2115 migration
        - Created migration_constraint_pattern.md docs
        - Added Migration Constraint Policy to CLAUDE.md

    - name: "Testing & Validation"
      duration: 30 minutes
      deliverables:
        - Smoke tested migration linter
        - Found and fixed 2 bugs (constraint detection logic, Windows paths)
        - Verified BLOCKING controls operational

  total_effort: "3.5 hours"

technical_details:
  files_created:
    - infra/scripts/check_config_drift.py: "260 lines - Config drift detector"
    - infra/scripts/validate_migration_constraints.py: "160 lines - Migration linter"
    - infra/scripts/migration_constraint_pattern.md: "100 lines - Pattern documentation"

  files_modified:
    - infra/scripts/deploy-direct.sh: "+20 lines - Drift check at step 3.5"
    - .pre-commit-config.yaml: "+8 lines - Migration constraint hook"
    - apps/backend-api/alembic/versions/20251214_2115_*.py: "93 lines rewritten - validate→fix→constrain"
    - CLAUDE.md: "+80 lines - 2 new CRITICAL policies"

bugs_found:
  - issue: "Migration linter not detecting violations"
    cause: "Checked entire file for validation patterns, not just content BEFORE constraint"
    fix: "Changed to check content[:match_pos] only"
    file: "infra/scripts/validate_migration_constraints.py:95-98"

  - issue: "Path matching failed on Windows"
    cause: "Windows backslashes vs forward slashes in path check"
    fix: "Normalized with filepath_str.replace('\\', '/')"
    file: "infra/scripts/validate_migration_constraints.py:187"

testing:
  smoke_tests:
    migration_linter:
      - scenario: "Block bad migrations"
        status: "PASS"
        detail: "Created test migration without pattern, linter detected violation with exit code 1"

      - scenario: "Pass good migrations"
        status: "PASS"
        detail: "Fixed 20251214_2115 migration passes without errors"

    config_drift_detector:
      - scenario: "Production validation pending"
        status: "DEFERRED"
        detail: "Requires AWS SSM access and EC2 instance running - will test during next deployment"

validation:
  pre_commit_hooks:
    - hook: "migration-constraint-check"
      status: "ACTIVE"
      enforcement: "BLOCKING"
      target: "apps/backend-api/alembic/versions/*.py"

  deployment_gates:
    - gate: "Config drift check"
      status: "ACTIVE"
      enforcement: "BLOCKING"
      location: "deploy-direct.sh step 3.5"

roi:
  time_investment: "3.5 hours implementation + testing"
  time_saved_per_incident: "65+ minutes"
  break_even_point: "After 2nd manual deploy or 1st similar incident"
  incidents_prevented:
    - "Config drift causing CORS errors (45 min)"
    - "Migration constraint failures (20 min)"
    - "Emergency data fixes during deployment"

deferred_work:
  - task: "GitHub Actions Phase 0 integration"
    effort: "0.5 hours"
    reason: "GHA disabled until Jan 2026 for billing"
    timeline: "Add when GHA re-enabled"

related_files:
  session: "sessions/20251215/SESSION-20251215-GOVERNANCE-POSTMORTEM-IMPROVEMENTS.md"
  plan: "C:\\Users\\mylai\\.claude\\plans\\splendid-seeking-platypus.md"
  postmortem: "sessions/20251215/SESSION-20251215-MANUAL-DEPLOYMENT-POSTMORTEM.md"
  documentation: "infra/scripts/migration_constraint_pattern.md"

knowledge_base:
  articles:
    - "KB-PATTERN-MIGRATION-CONSTRAINT.md: Migration constraint pattern guide"
    - "Configuration Drift Policy in CLAUDE.md:513-538"
    - "Migration Constraint Policy in CLAUDE.md:541-581"

success_metrics:
  baseline:
    total_time: "180 min"
    config_drift_issues: 1
    migration_issues: 1
    avoidable_time: "65 min"

  target:
    config_drift_issues: 0
    migration_issues: 0
    avoidable_time: 0

next_steps:
  - "Test config drift detector during next production deployment"
  - "Monitor incidents prevented by these controls"
  - "Add GHA Phase 0 integration when GitHub Actions re-enabled"

tags:
  - governance
  - deployment-safety
  - pre-commit-hooks
  - config-drift
  - migration-validation
  - blocking-controls
  - post-mortem
  - preventive-control

lessons_learned: |
  1. Post-mortem analysis is most valuable when followed by preventive control implementation
  2. BLOCKING controls (exit code 1) are more effective than warnings
  3. Pre-commit hooks catch issues before they reach production
  4. Configuration drift between environments is a common deployment failure mode
  5. Data validation MUST happen before constraint addition in migrations
  6. "Validate → Fix → Constrain" pattern prevents entire class of migration failures
