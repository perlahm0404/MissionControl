id: RIS-TASK-GOV-016
title: "Install Core Safety Guardrails Bundle v1.8.2"
status: completed
risk_level: HIGH
category: governance
created_at: 2025-11-27T00:00:00Z
updated_at: 2025-11-27T00:00:00Z

bundle:
  name: "Core Safety Guardrails"
  version: "1.8.2"
  components:
    - drift_detector
    - static_environment_contract
    - forbidden_operations_guard
    - semantic_diff_auditor

summary: |
  Install Bundle 1: Core Safety Guardrails (v1.8.2) to prevent drift, enforce
  environmental contracts, block dangerous operations, and detect semantic changes
  before they cause system instability.

components:
  component_1:
    name: "Drift Detector"
    path: ".claude/commands/drift-detector.md"
    type: "slash_command"
    auto_run:
      - "/boot"
      - "/claire"
      - "/session-start"
    purpose: |
      Scans repository for directory drift, config drift, capsule drift, hook drift,
      environment drift, and secrets location drift. Validates canonical paths and
      raises RIS incidents for violations.
    enforcement:
      - "LOW/MEDIUM: auto-fix with logging"
      - "HIGH/CRITICAL: block + RIS incident + human approval"

  component_2:
    name: "Static Environment Contract (SEC)"
    paths:
      contract: "governance/static-environment-contract-v1.8.2.md"
      guard: ".claude/commands/sec-guard.md"
    type: "governance_document + enforcement_hook"
    purpose: |
      Authoritative, immutable definitions for:
      - Allowed environment variables
      - Allowed config file locations
      - Allowed secret sources (dev: .env.local, prod: AWS SM)
      - Allowed import paths
      - Allowed directory structure
      - Forbidden drifting patterns
    enforcement:
      - "Validates before ALL file/config/env operations"
      - "Blocks violations unless RIS + human approval"

  component_3:
    name: "Forbidden Operations Guard"
    path: ".claude/commands/forbidden-ops.md"
    type: "pre_execution_hook"
    purpose: |
      Blocks high-risk operations unless RIS task + human approval provided.
    forbidden_operations:
      - "Schema migrations (alembic upgrade/downgrade/revision)"
      - "Dockerfile edits"
      - "Infrastructure edits (terraform apply/destroy, cloudformation)"
      - "AWS IAM or access key creation"
      - "Volume mount changes (docker-compose.yml)"
      - "Repository structural moves (top-level directories)"
      - "Deletion outside zdelete/"
      - "Import path rewrites (multi-file changes)"
    enforcement:
      - "IMMEDIATE BLOCK on detection"
      - "Create RIS incident"
      - "Require approval workflow"
      - "Execute under supervision if approved"
    exceptions:
      - "Emergency override (production incidents only)"
      - "Development override (local testing, documented)"

  component_4:
    name: "Semantic Diff Auditor"
    paths:
      script: "scripts/auditors/semantic_diff.py"
      guard: ".claude/commands/semantic-diff-guard.md"
    type: "python_script + enforcement_hook"
    purpose: |
      Compares old vs new file versions to detect semantic (meaning) changes,
      not just textual differences. Classifies risk and blocks HIGH/CRITICAL
      changes automatically.
    detection_patterns:
      critical:
        - "Database connection string changes"
        - "AWS secret key changes"
        - "JWT secret changes"
        - "Schema changes (CREATE/ALTER/DROP TABLE)"
        - "Database migrations"
        - "AWS IAM operations"
        - "Dockerfile base image changes"
        - "Docker port exposure changes"
      high:
        - "Function signature changes"
        - "Class inheritance changes"
        - "Import statement changes"
        - "Decorator changes"
        - "Docker volume/port configurations"
        - "Terraform resource changes"
      medium:
        - "Return value changes"
        - "Exception handling changes"
        - "Conditional/loop logic changes"
        - "Async function changes"
      low:
        - "Comment changes"
        - "Docstring changes"
        - "Whitespace changes"
        - "Debug print statements"
    enforcement:
      - "LOW/MEDIUM: auto-proceed + log"
      - "HIGH: block + require approval"
      - "CRITICAL: full stop + RIS incident + human review"

integration:
  workflow_hooks:
    - "/boot: runs drift-detector"
    - "/claire: runs drift-detector"
    - "/session-start: runs drift-detector"
    - "pre-file-operation: runs sec-guard"
    - "pre-execution: runs forbidden-ops"
    - "pre-modification: runs semantic-diff-guard"

  session_ledger:
    - "All guard findings appended to session ledger"
    - "Format: markdown sections with timestamps"
    - "Includes: operation, risk, action, RIS reference"

  tam_integration:
    enabled_for:
      - "LOW risk operations (auto-execute)"
      - "MEDIUM risk operations (auto-execute with confirmation)"
    disabled_for:
      - "HIGH risk operations (require approval)"
      - "CRITICAL risk operations (full stop)"

  ris_integration:
    incidents:
      - "AUTO-CREATED for HIGH/CRITICAL drift"
      - "AUTO-CREATED for forbidden operations"
      - "AUTO-CREATED for CRITICAL semantic changes"
    tasks:
      - "REQUIRED for approval overrides"
      - "REQUIRED for SEC amendments"
      - "REQUIRED for forbidden operation approvals"

paths_created:
  - ".claude/commands/drift-detector.md"
  - "governance/static-environment-contract-v1.8.2.md"
  - ".claude/commands/sec-guard.md"
  - ".claude/commands/forbidden-ops.md"
  - "scripts/auditors/semantic_diff.py"
  - ".claude/commands/semantic-diff-guard.md"
  - "ris/tasks/RIS-TASK-GOV-016-CORE-SAFETY-GUARDRAILS.yaml"
  - "docs/kb/governance/core_safety_guardrails_v1.8.2.md"

test_plan:
  drift_detector:
    - name: "Test directory drift detection"
      steps:
        - "Create unauthorized directory outside canonical structure"
        - "Run /drift-detector"
        - "Verify MEDIUM/HIGH risk reported"
        - "Verify auto-fix or approval request"

    - name: "Test config drift detection"
      steps:
        - "Create forbidden config file (.env.production)"
        - "Run /drift-detector"
        - "Verify CRITICAL risk reported"
        - "Verify operation blocked"

    - name: "Test capsule drift detection"
      steps:
        - "Create legacy capsule file (.claude/capsule-v1.8.1.md)"
        - "Run /drift-detector"
        - "Verify drift reported"
        - "Verify archival to zdelete/"

  sec_guard:
    - name: "Test env var validation"
      steps:
        - "Attempt to add unauthorized env var"
        - "Verify SEC guard blocks operation"
        - "Verify RIS task creation prompt"

    - name: "Test secret location validation"
      steps:
        - "Attempt to hardcode AWS secret in code"
        - "Verify CRITICAL violation"
        - "Verify operation blocked"

    - name: "Test import path validation"
      steps:
        - "Attempt forbidden import pattern (sys.path.append)"
        - "Verify violation detected"
        - "Verify operation blocked"

  forbidden_ops:
    - name: "Test schema migration block"
      steps:
        - "Attempt: alembic upgrade head"
        - "Verify IMMEDIATE BLOCK"
        - "Verify RIS incident created"
        - "Verify approval workflow prompted"

    - name: "Test Dockerfile edit block"
      steps:
        - "Attempt to edit Dockerfile"
        - "Verify operation blocked"
        - "Verify RIS task required"

    - name: "Test terraform apply block"
      steps:
        - "Attempt: terraform apply"
        - "Verify CRITICAL block"
        - "Verify approval required"

  semantic_diff:
    - name: "Test CRITICAL pattern detection"
      steps:
        - "Modify DATABASE_URL in code"
        - "Run semantic diff"
        - "Verify CRITICAL risk classification"
        - "Verify operation blocked"

    - name: "Test HIGH pattern detection"
      steps:
        - "Change function signature"
        - "Run semantic diff"
        - "Verify HIGH risk classification"
        - "Verify approval required"

    - name: "Test LOW pattern detection"
      steps:
        - "Change comments only"
        - "Run semantic diff"
        - "Verify LOW risk classification"
        - "Verify auto-proceed"

validation_checklist:
  - label: "All components created"
    status: "✅"
    paths:
      - ".claude/commands/drift-detector.md"
      - "governance/static-environment-contract-v1.8.2.md"
      - ".claude/commands/sec-guard.md"
      - ".claude/commands/forbidden-ops.md"
      - "scripts/auditors/semantic_diff.py"
      - ".claude/commands/semantic-diff-guard.md"

  - label: "Enforcement hooks installed"
    status: "✅"
    hooks:
      - "drift-detector (auto-run on boot/claire/session-start)"
      - "sec-guard (pre-execution)"
      - "forbidden-ops (pre-execution)"
      - "semantic-diff-guard (pre-modification)"

  - label: "TAM integration configured"
    status: "✅"
    details: "LOW/MEDIUM auto-execute, HIGH/CRITICAL require approval"

  - label: "Session ledger integration"
    status: "✅"
    details: "All findings appended automatically"

  - label: "RIS integration configured"
    status: "✅"
    details: "Incidents/tasks auto-created for HIGH/CRITICAL findings"

  - label: "KB documentation created"
    status: "✅"
    path: "docs/kb/governance/core_safety_guardrails_v1.8.2.md"

next_steps:
  - action: "Integrate guards with /claire command"
    priority: "HIGH"
    description: "Update claire.md to invoke all guards automatically"

  - action: "Test all guards end-to-end"
    priority: "HIGH"
    description: "Execute test plan to validate behavior"

  - action: "Update governance index"
    priority: "MEDIUM"
    description: "Add SEC and guardrails to governance/index.md"

  - action: "Create session ledger template"
    priority: "MEDIUM"
    description: "Standardize session ledger format for guard outputs"

notes: |
  Bundle 1: Core Safety Guardrails v1.8.2 installation complete.

  All four components installed:
  1. ✅ Drift Detector
  2. ✅ Static Environment Contract (SEC) + SEC Guard
  3. ✅ Forbidden Operations Guard
  4. ✅ Semantic Diff Auditor + Guard

  RIS documentation created: RIS-TASK-GOV-016
  KB documentation created: core_safety_guardrails_v1.8.2.md

  Guards are ready for integration with /boot, /claire, /session-start workflows.
  TAM compatible: LOW/MEDIUM operations auto-execute, HIGH/CRITICAL require approval.

  No conflicts detected during installation.
