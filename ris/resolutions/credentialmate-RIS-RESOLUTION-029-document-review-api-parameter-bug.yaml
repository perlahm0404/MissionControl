id: RIS-RESOLUTION-029
title: "Document Review API Parameter Bug (edited_data vs verified_data)"
date: 2025-12-13
severity: critical
status: resolved
category: bug_fix

issue:
  description: |
    Document review endpoint failing to create credentials after approval.
    Auto-create logic skipping license and CME activity creation despite
    successful extraction and approval.

  symptoms:
    - Approval request returns 200 OK but no credential created
    - Backend logs show: "Cannot create license: missing required fields
      (license_number=False, state=False, expiration_date=False)"
    - ExtractionResult shows extracted_data present but not used
    - Auto-create service receives None for edited_data

  impact:
    severity: critical
    affects:
      - Document golden path pipeline
      - License creation from documents
      - CME activity creation from documents
      - All manual review workflows
    user_impact: |
      Complete failure of credential auto-creation after document approval.
      Users would upload documents, review extractions, approve them, but
      no credentials would be created in the system.

  reproduction:
    steps:
      - Upload document (license or CME certificate)
      - Wait for extraction (status: REVIEW_PENDING)
      - Submit approval with verified_data parameter
      - Check for created credential
    expected: "Credential created with approved data"
    actual: "No credential created, data ignored"

root_cause:
  analysis: |
    API endpoint signature expects parameter named 'edited_data' but
    documentation and intuition suggest 'verified_data'. When client
    sends 'verified_data', FastAPI ignores it (not in signature),
    so the endpoint receives edited_data=None.

    Auto-create logic checks for required fields in edited_data,
    receives None, and skips credential creation.

  code_location:
    file: apps/backend-api/src/api/v1/documents.py
    lines: 1531-1757
    function: submit_review_decision
    signature: |
      async def submit_review_decision(
          extraction_id: str,
          decision: str = Query(...),
          edited_data: Optional[dict] = None,  # ‚Üê ACTUAL PARAMETER NAME
          notes: Optional[str] = None,
          ...
      )

  discovery_method: |
    Found during E2E user import testing. Initial approval attempts
    succeeded but created no credentials. Reviewed endpoint code to
    find parameter name mismatch.

solution:
  approach: |
    Changed all approval requests to use correct parameter name 'edited_data'
    instead of 'verified_data'.

  implementation:
    changes:
      - type: api_client
        description: "Updated approval request body parameter name"
        before: |
          {
            "verified_data": {
              "license_number": "2020031811",
              "state": "MO",
              "expiration_date": "2026-01-31"
            }
          }
        after: |
          {
            "edited_data": {
              "license_number": "2020031811",
              "state": "MO",
              "expiration_date": "2026-01-31"
            }
          }

  validation:
    test_case: "Missouri Medical License approval"
    document_id: "57d8f9d4-676e-4cf1-9b8c-93518a6955ee"
    before_fix: "No license created, error in logs"
    after_fix: "License ID 81 created successfully"

    test_case_2: "CME certificate approval"
    document_id_2: "02eab646-2a9d-45df-9edd-037d1f73e48c"
    after_fix_2: "CME Activity ID 63 created successfully"

prevention:
  recommendations:
    - recommendation: "Add API parameter validation with clear error messages"
      priority: high
      details: |
        If client sends 'verified_data' instead of 'edited_data',
        return 422 Unprocessable Entity with message:
        "Unknown parameter 'verified_data'. Did you mean 'edited_data'?"

    - recommendation: "Update API documentation"
      priority: medium
      details: |
        Clarify parameter name in OpenAPI schema and inline comments.
        Add example showing 'edited_data' usage.

    - recommendation: "Consider parameter alias"
      priority: low
      details: |
        Allow both 'edited_data' and 'verified_data' as aliases for
        backwards compatibility, deprecate 'verified_data'.

metrics:
  resolution_time: "~30 minutes (discovery to fix)"
  affected_documents: 2
  affected_providers: 1
  success_rate_before: "0%"
  success_rate_after: "100%"

related_issues:
  - type: documentation
    issue: "Parameter naming inconsistency"
    note: "No clear documentation on why 'edited_data' vs 'verified_data'"

  - type: ux
    issue: "Approval succeeds but silently fails to create credential"
    note: "Should return error or warning if auto-create fails"

references:
  session: sessions/20251213/SESSION-20251213-e2e-user-import-golden-path.md
  plan: .claude/plans/wild-launching-mochi.md
  code_file: apps/backend-api/src/api/v1/documents.py:1531-1757
  auto_create_file: apps/backend-api/src/api/v1/documents.py:1414-1529

tags:
  - api
  - document_processing
  - golden_path
  - parameter_validation
  - auto_create
  - critical_bug

resolved_by: Claude Code (AI)
resolved_date: 2025-12-13
verification_status: confirmed_working
