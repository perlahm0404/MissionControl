---
id: RIS-046
title: "Branch Consolidation: vf → main (Trunk Unification)"
date: 2024-12-11
severity: high
status: resolved
lane: infra
priority: p1
type: process
tags: [git, branching, deployment, governance]

# ISSUE

## Problem Statement
Git branch confusion caused by dual trunk situation:
- `vf` branch was being used as production trunk (Nov-Dec 2024)
- `main` branch existed as "legacy" but received accidental commits
- 2 commits were pushed to `main` after it was declared legacy (fc96ecf, 0a9759c)
- Risk of future accidents where work goes to wrong branch
- GitHub Actions workflows triggered on both branches
- Unclear mental model for developers: "Which branch is the trunk?"

## Impact
- **Developer Confusion**: Unclear which branch to create PRs against
- **Deployment Risk**: Potential to deploy from wrong branch
- **Workflow Complexity**: Dual branch triggers in CI/CD
- **Future Accidents**: High likelihood of repeat confusion

## Root Cause
Incomplete migration from `main` to `vf`:
1. `vf` was created as trunk during Nov 2024 migration
2. `main` was declared "legacy" but not deleted
3. Accidental pushes to `main` occurred (Dec 8, 2024)
4. No enforcement mechanism to prevent `main` usage
5. Historical Git convention favors `main` as trunk

# RESOLUTION

## Decision
**Reset `main` to match `vf` and use `main` as the trunk going forward.**

### Rationale
1. **Standard Convention**: `main` is the de facto standard for Git trunk branches
2. **Prevent Future Accidents**: Developers naturally work on `main`
3. **Simpler Mental Model**: One clear trunk, no confusion
4. **Clean History**: All work from `vf` preserved in `main`
5. **Easier Communication**: "All PRs to main" is simpler than "All PRs to vf"

### Alternative Considered
**Keep `vf` as trunk, delete `main`**: Rejected because:
- Breaks Git conventions (main is standard)
- Higher risk of future accidents (developers expect main)
- More confusing for external contributors
- Requires constant education ("don't use main")

## Implementation

### Step 1: Reset main to vf
```bash
git checkout main
git reset --hard vf  # main now at 586df48
git push origin main --force  # ✅ Completed 2024-12-11
```

**Result**: `main` now contains all 94 commits from `vf`

### Step 2: Update GitHub Actions Workflows
Modified workflows to trigger on `main` only:
- `.github/workflows/frontend-build.yml` (line 16, 20)
- `.github/workflows/test-unit.yml` (line 16, 18)

**Before**:
```yaml
on:
  pull_request:
    branches: [main, vf]
  push:
    branches: [main, vf]
```

**After**:
```yaml
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
```

### Step 3: Update CLAUDE.md Documentation
Updated Git Branch Strategy section (CLAUDE.md:501-508):

**Before**:
```markdown
**TRUNK BRANCH: `vf`** (NOT `main`)
- `vf` = production trunk, all PRs merge here
- `main` = LEGACY, do not use
```

**After**:
```markdown
**TRUNK BRANCH: `main`**
- `main` = production trunk, all PRs merge here
- Feature branches = short-lived branches for specific work

**Historical Note:** The `vf` branch was the trunk from Nov 2024 - Dec 2024
during a migration period. It has been merged back into `main` as of Dec 11, 2024.
```

### Step 4: Consolidation Commit
Created commit documenting the change:
- Commit: `62a6bc8` - "chore: consolidate vf into main - main is now the trunk"
- Pushed to remote successfully
- Includes full rationale and context

## Verification

### Pre-Implementation State
```
main:  fc96ecf (2 commits ahead of vf's merge base)
vf:    586df48 (94 commits ahead of main's merge base)
Status: DIVERGED ❌
```

### Post-Implementation State
```
main:  62a6bc8 (contains all vf commits + consolidation commit)
vf:    586df48 (1 commit behind main)
Status: ALIGNED ✅
```

### Commits Discarded
The following 2 commits on old `main` were discarded (already superseded by vf):
1. `fc96ecf` - "fix: Add comment to force workflow reload" (trivial)
2. `0a9759c` - "feat(deploy): Switch to production OIDC role and SHA tags"
   - Already incorporated in vf's superior 4-phase deployment (586df48)

# RISK ASSESSMENT

## Risks Eliminated
1. ✅ **Branch Confusion**: Single trunk eliminates ambiguity
2. ✅ **Accidental Commits**: Developers naturally use `main`
3. ✅ **Deployment Errors**: Clear deployment source
4. ✅ **Workflow Complexity**: Single branch trigger

## Residual Risks
1. **Historical `vf` References**: Code/docs might reference `vf`
   - **Mitigation**: Search and update references
   - **Timeline**: Ongoing cleanup

2. **Developer Habit**: Team might still try to use `vf`
   - **Mitigation**: Communication + eventually delete `vf`
   - **Timeline**: Delete after 1 week confirmation

3. **External PRs**: Open PRs might target `vf`
   - **Mitigation**: Update PR base branch to `main`
   - **Timeline**: Check weekly

## Follow-Up Actions
- [ ] Verify GitHub default branch is `main` (Settings > Branches)
- [ ] Delete `vf` branch after 1 week confirmation period
  ```bash
  git push origin --delete vf
  git branch -d vf
  ```
- [ ] Communicate to team: "main is now the trunk"
- [ ] Update any documentation referencing `vf` as trunk
- [ ] Monitor for accidental `vf` usage over next 2 weeks

# METRICS

## Complexity Reduction
- **Before**: 2 trunk branches, 6 workflow triggers
- **After**: 1 trunk branch, 3 workflow triggers
- **Improvement**: 50% reduction in branch complexity

## Deployment Clarity
- **Before**: Deploy from `vf`, but `main` exists
- **After**: Deploy from `main` (standard convention)
- **Improvement**: Zero ambiguity

# RELATED ITEMS

## RIS References
- RIS-043: Bash Permission Governance (permission cleanup)
- RIS-044: Governance Automation Infrastructure (hooks, validation)

## Knowledge Base
- KB: Git Branch Strategy Best Practices (to be created)
- KB: Branch Migration Playbook (to be created)

## Sessions
- SESSION-20251211-branch-consolidation.md

# SIGN-OFF

**Executed By**: Claude Code (Assistant)
**Approved By**: User (mylaiviet)
**Execution Date**: 2024-12-11
**Status**: ✅ Resolved
**Confidence**: High

## Rollback Plan
If issues arise, rollback is simple:
```bash
# Restore vf as trunk
git checkout vf
git checkout -b main-backup  # Backup current main
git branch -D main
git checkout -b main
git push origin main --force

# Restore workflow configs
git revert 62a6bc8
```

**Rollback Risk**: Low (all code preserved, force push acceptable on main)
