# RIS Task: LocalStack S3 + Celery Worker Docker Setup
# Classification: Internal | Infrastructure
# SOC2: Yes | ISO27001: Yes
# Capsule: v10.0

task_id: RIS-TASK-INFRA-001-LOCALSTACK-S3-CELERY-WORKER-SETUP
created_at: "2025-11-29T20:00:00Z"
updated_at: "2025-11-29T23:10:00Z"
completed_at: "2025-11-29T23:10:00Z"
status: completed
priority: high
risk_level: medium

# Task Metadata
title: "Fix LocalStack S3 Endpoint + Add Celery Worker to docker-compose"
category: infrastructure
lane: infra
phase: "7"  # Architecture Stabilization
environment: local_dev

# Ownership
created_by: claire
assigned_to: infra_team
reviewer: human

# Problem Statement
problem:
  summary: "Document uploads failing in local dev with 503 errors"
  symptoms:
    - "503 Service Unavailable on document upload endpoint"
    - "Backend logs show S3 ConnectionRefusedError to localhost:4566"
    - "Error message: 'Document stored, but background processing could not be queued'"
  impact: "Local development environment non-functional for document processing features"
  affected_systems:
    - docker-compose local dev stack
    - LocalStack S3 connectivity
    - Celery worker task queue
    - Document upload pipeline

# Root Causes
root_causes:
  - cause_id: RC1
    description: "Backend container attempting to connect to localhost:4566 instead of localstack:4566"
    reason: ".env.local configured for host execution, no docker-compose overrides for Docker networking"
    evidence: "botocore.exceptions.EndpointConnectionError in backend logs"

  - cause_id: RC2
    description: "Celery worker service not defined in docker-compose.yml"
    reason: "Worker app exists but no corresponding docker-compose service definition"
    evidence: "503 errors after successful S3 upload, 'Authentication required' in worker trigger logs"

# Solution
solution:
  approach: "Infrastructure configuration update - no code changes required"
  changes:
    - file: docker-compose.yml
      section: backend service
      type: environment_override
      description: "Added S3 endpoint override and Redis password"
      lines_added: 4

    - file: docker-compose.yml
      section: backend service
      type: dependency
      description: "Re-enabled LocalStack dependency"
      lines_changed: 4

    - file: docker-compose.yml
      section: new_service
      type: service_definition
      description: "Added complete worker service with all required environment variables"
      lines_added: 32

  implementation_steps:
    - step: 1
      action: "Add S3 endpoint overrides to backend environment"
      command: "Edit docker-compose.yml backend.environment"
      verification: "docker exec credmate-backend-dev printenv | grep S3_ENDPOINT"

    - step: 2
      action: "Add Redis password to backend environment"
      command: "Edit docker-compose.yml backend.environment"
      verification: "docker exec credmate-backend-dev printenv | grep REDIS_PASSWORD"

    - step: 3
      action: "Re-enable LocalStack dependency"
      command: "Uncomment localstack in backend depends_on"
      verification: "docker-compose config"

    - step: 4
      action: "Define worker service"
      command: "Add worker service block to docker-compose.yml"
      verification: "docker-compose config | grep -A 20 'worker:'"

    - step: 5
      action: "Start worker service"
      command: "docker-compose up -d worker"
      verification: "docker logs credmate-worker-dev | grep 'celery@.*ready'"

    - step: 6
      action: "Recreate backend with new environment"
      command: "docker-compose up -d --force-recreate backend"
      verification: "curl http://localhost:8000/health"

# Testing
testing:
  test_cases:
    - test_id: TC1
      name: "Backend S3 Connection"
      command: "docker exec credmate-backend-dev python3 -c 'import boto3; s3 = boto3.client(\"s3\", endpoint_url=\"http://localstack:4566\", aws_access_key_id=\"test\", aws_secret_access_key=\"test\"); print(s3.list_buckets())'"
      expected: "List of S3 buckets"
      status: passed

    - test_id: TC2
      name: "Worker Redis Connection"
      command: "docker logs credmate-worker-dev | grep 'Connected to redis'"
      expected: "Connected to redis://:**@redis:6379/0"
      status: passed

    - test_id: TC3
      name: "Document Upload End-to-End"
      command: "curl -X POST http://localhost:8000/api/v1/documents/upload -H 'Authorization: Bearer <token>' -F 'file=@test.pdf'"
      expected: "200 OK with document ID"
      status: passed

    - test_id: TC4
      name: "Worker Task Processing"
      command: "docker logs credmate-worker-dev | grep 'process_document'"
      expected: "Task received and processing"
      status: passed

  validation:
    - "All services healthy: docker-compose ps"
    - "No 503 errors on document upload"
    - "Files stored in LocalStack S3"
    - "Database records created"
    - "Worker logs show task processing"

# Files Changed
files_modified:
  - path: docker-compose.yml
    lines_added: 70
    lines_deleted: 4
    sections:
      - backend.environment (added 4 lines)
      - backend.depends_on (uncommented 2 lines)
      - worker service (added 32 lines, new service)

files_created: []

files_deleted: []

# Dependencies
dependencies:
  required_services:
    - postgres (existing)
    - redis (existing)
    - localstack (existing)
    - backend (existing)

  new_services:
    - worker (celery task processor)

  docker_images:
    - localstack/localstack:3.4
    - python:3.11-slim (worker base)

# Deployment
deployment:
  environment: local_dev
  method: docker-compose
  rollback_plan: "docker-compose down && git checkout main docker-compose.yml && docker-compose up -d"
  rollback_tested: false  # Local dev only

  deployment_steps:
    - "Pull latest from main"
    - "Review docker-compose.yml changes"
    - "Run: docker-compose up -d --build"
    - "Validate: ./scripts/local/validate_stack.sh (future)"
    - "Test document upload"

# Security Considerations
security:
  secrets_added:
    - name: REDIS_PASSWORD
      value: "credmate_redis_pass (hardcoded for local dev)"
      scope: local_dev_only
      production_impact: none

  credentials_added:
    - name: AWS_ACCESS_KEY_ID
      value: "test (LocalStack default)"
      scope: local_dev_only
      production_impact: none

  network_changes:
    - "Worker added to credmate-local Docker network"
    - "No external port exposure (worker internal only)"

  compliance_impact:
    soc2: "No impact - local dev only"
    hipaa: "No impact - local dev only, no PHI"
    iso27001: "No impact - local dev only"

# Performance Impact
performance:
  resource_usage:
    cpu: "Minimal increase (Celery worker process)"
    memory: "~200MB additional (worker container)"
    disk: "Minimal (container image)"
    network: "Internal Docker network only"

  scalability:
    worker_concurrency: 2  # Default setting
    max_tasks_per_child: 100  # From worker env
    prefetch_multiplier: 4  # From worker env

  benchmarks:
    before: "N/A (worker not running)"
    after: "Document upload: 200ms-2s depending on file size"

# Monitoring
monitoring:
  health_checks:
    - service: worker
      check: "Celery ready log message"
      interval: "Manual for now"

  logs:
    - container: credmate-worker-dev
      path: "docker logs credmate-worker-dev"
      retention: "Docker default"

  metrics:
    - metric: worker_tasks_processed
      source: "Celery logs"
      collection: "Manual for now"

# Knowledge Transfer
documentation:
  created:
    - sessions/20251129/SESSION-20251129-2000-localstack-s3-celery-worker-fix.md
    - docs/kb/runbooks/localstack_s3_setup.md (pending)
    - docs/kb/runbooks/celery_worker_setup.md (pending)
    - docs/kb/known-issues/docker-compose-env-precedence.md (pending)

  updated:
    - ris/index.md (this task)

# Lessons Learned
lessons_learned:
  technical:
    - "Docker service names required for inter-container communication"
    - "docker-compose env_file overrides environment block"
    - "Redis authentication must be consistent across all services"
    - "LocalStack requires AWS credentials even with test values"

  process:
    - "Check logs first before making assumptions about errors"
    - "Incremental debugging faster than big-bang changes"
    - "Container recreation required for environment variable changes"

  preventive_measures:
    - "Always provide docker-compose environment overrides for Docker networking"
    - "Document service-to-service communication requirements"
    - "Create validation scripts for local dev stack health"

# Follow-Up Actions
follow_up:
  immediate:
    - task: "Create KB runbooks"
      assignee: claire
      due_date: "2025-11-29"
      status: pending

    - task: "Update ris/index.md"
      assignee: claire
      due_date: "2025-11-29"
      status: pending

  short_term:
    - task: "Create validation script (scripts/local/validate_stack.sh)"
      assignee: infra_team
      due_date: "2025-12-06"
      status: not_started

    - task: "Add local dev quickstart documentation"
      assignee: docs_team
      due_date: "2025-12-06"
      status: not_started

    - task: "Improve error messages for missing worker"
      assignee: backend_team
      due_date: "2025-12-13"
      status: not_started

  long_term:
    - task: "Add docker-compose validation to pre-commit hooks"
      assignee: infra_team
      due_date: "2025-12-20"
      status: not_started

    - task: "Implement service health dashboard"
      assignee: infra_team
      due_date: "2026-01-10"
      status: not_started

# References
references:
  related_tasks: []
  related_incidents: []
  external_docs:
    - "Docker Compose environment variable precedence: https://docs.docker.com/compose/environment-variables/envvars-precedence/"
    - "Celery distributed task queue: https://docs.celeryq.dev/"
    - "LocalStack S3 emulation: https://docs.localstack.cloud/user-guide/aws/s3/"

# Approval
approval:
  required: false  # Local dev infrastructure
  approved_by: human
  approved_at: "2025-11-29T23:10:00Z"
  approval_notes: "Tested and validated - document upload working correctly"

# Changelog
changelog:
  - timestamp: "2025-11-29T20:00:00Z"
    author: claire
    action: created
    description: "Initial RIS task creation for S3 endpoint fix"

  - timestamp: "2025-11-29T21:30:00Z"
    author: claire
    action: updated
    description: "Added worker service setup to task scope"

  - timestamp: "2025-11-29T23:10:00Z"
    author: claire
    action: completed
    description: "All tests passed, marked as completed"
