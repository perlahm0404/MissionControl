incident_id: RIS-071
title: Runtime Code Importing from Scripts Directory
date: 2025-12-14
severity: high
status: resolved
category: architecture

summary: |
  CME Harmonizer endpoint returned 500 errors due to ModuleNotFoundError
  when runtime service code attempted to import CANONICAL_TOPICS from
  scripts/seed_cme_requirements.py directory.

root_cause: |
  apps/backend-api/src/core/services/cme_compliance_service.py imported
  CANONICAL_TOPICS from scripts/seed_cme_requirements.py using sys.path
  manipulation (lines 66-76). This worked in local development but failed
  in Docker production where scripts/ is not in PYTHONPATH.

  The developer attempted to centralize topic definitions during SSOT
  implementation but chose import from seed script instead of creating
  proper constants module.

impact:
  production_outage: true
  affected_endpoints:
    - /api/v1/cme/compliance/harmonize
  error_message: "ModuleNotFoundError: No module named 'scripts'"
  user_facing_error: "Error Loading Data - Failed to fetch"
  duration: "Dec 14, 2025 2:39 PM - Dec 14, 2025 5:45 PM (3 hours 6 minutes)"
  affected_users: "All users accessing CME Harmonizer page"

timeline:
  - time: "2025-12-14 14:39:28"
    event: "Bug introduced in commit 4e6a38c"
    actor: "Claude Code Security Agent"
    commit: "feat(cme): enhance CME compliance with FSMB metadata and SSOT validation"

  - time: "2025-12-14 14:40:00"
    event: "Batch commit of multiple session files"
    note: "Bug committed along with SSOT implementation work"

  - time: "2025-12-14 14:40:00 - 17:45:00"
    event: "Production outage period"
    note: "Any user loading CME Harmonizer page received 500 error"

  - time: "2025-12-14 17:45:00"
    event: "Bug discovered during investigation"
    note: "User reported 'Error Loading Data' on CME Harmonizer page"

  - time: "2025-12-14 17:50:00"
    event: "Root cause identified"
    note: "Module import from scripts/ failed in Docker production"

  - time: "2025-12-14 18:00:00"
    event: "Immediate fix deployed"
    note: "Rewrote _topic_matches_requirement() to use database queries"

  - time: "2025-12-14 18:30:00"
    event: "Preventive measures implemented"
    note: "Created constants module, added Ruff TID252 rule, updated governance"

immediate_fix:
  - action: "Rewrote _topic_matches_requirement() function"
    file: "apps/backend-api/src/core/services/cme_compliance_service.py"
    change: "Query database for topic aliases instead of importing from scripts"
    commit: "fix(cme): rewrite topic matching to use database instead of script import"

  - action: "Added db parameter to function signature"
    before: "_topic_matches_requirement(activity_topics, required_topic)"
    after: "_topic_matches_requirement(db, activity_topics, required_topic)"

  - action: "Removed sys.path manipulation"
    removed_lines: "66-76, 88"
    reason: "Eliminated fragile path hacking"

permanent_fix:
  - action: "Created constants module"
    file: "apps/backend-api/src/contexts/cme/constants.py"
    content: "CANONICAL_TOPICS and CANONICAL_CATEGORIES definitions"
    benefit: "Single Source of Truth (SSOT) for topic definitions"

  - action: "Updated compliance service"
    file: "apps/backend-api/src/core/services/cme_compliance_service.py"
    change: "Import from contexts.cme.constants instead of scripts"

  - action: "Updated seed script"
    file: "apps/backend-api/scripts/seed_cme_requirements.py"
    change: "Import CANONICAL_TOPICS from contexts.cme.constants"
    note: "Scripts now import from runtime code (correct pattern)"

preventive_measures:
  linting:
    - tool: "Ruff TID252"
      file: "apps/backend-api/ruff.toml"
      rule: "Ban imports from scripts/ directory"
      enforcement: "Pre-commit hook (BLOCKING)"
      message: "Runtime code MUST NOT import from scripts directory. Move constants to contexts/*/constants.py"

  governance:
    - document: "CLAUDE.md"
      section: "§ Python Import Policy"
      added: "2025-12-14"
      content: "Comprehensive rules for runtime vs script imports"

    - document: "CLAUDE.md"
      section: "§ When to Create Skills vs Pre-Commit Hooks"
      added: "2025-12-14"
      content: "Strategic guidelines for skill creation decisions"

  skill_updates:
    - skill: "backend-validator"
      file: ".claude/skills/backend-validator/SKILL.md"
      added: "Step 2.5: Check Import Patterns (TID252)"
      benefit: "Educational output explains WHY violations occur"

  testing:
    - type: "Integration test"
      file: "apps/backend-api/tests/integration/cme/test_harmonize_endpoint.py"
      status: "planned"
      coverage: "POST /api/v1/cme/compliance/harmonize"

    - type: "Unit test"
      file: "apps/backend-api/tests/unit/cme/test_topic_matching.py"
      status: "planned"
      coverage: "_topic_matches_requirement() function with aliases"

  documentation:
    - type: "RIS Resolution"
      file: "ris/resolutions/RIS-RESOLUTION-071-runtime-script-import-anti-pattern.yaml"
      purpose: "Incident documentation"

    - type: "Knowledge Base"
      file: "docs/kb/KB-005-python-import-anti-patterns.md"
      purpose: "Architectural guidance for future developers"

lessons_learned:
  test_coverage_gaps:
    - gap: "No integration test for /api/v1/cme/compliance/harmonize endpoint"
      lesson: "Import errors only caught when endpoint executed"
      action: "Add integration tests for all critical API endpoints"

    - gap: "No unit test for _topic_matches_requirement() function"
      lesson: "Private function with broken import never called in tests"
      action: "Test critical helper functions even if private"

    - gap: "Test PYTHONPATH differs from production"
      lesson: "Tests passed locally and in CI/CD but production failed"
      action: "Ensure test environment mirrors production constraints"

  architectural_decisions:
    - decision: "Shortcuts during SSOT implementation"
      lesson: "Importing from seed script seemed expedient but fragile"
      action: "Always create proper module structure for shared data"

    - decision: "sys.path manipulation works locally"
      lesson: "Local dev path behavior != Docker production path behavior"
      action: "Avoid sys.path hacks; use proper Python package structure"

  governance_gaps:
    - gap: "No linting rule for import anti-patterns"
      lesson: "Static analysis could have caught this before commit"
      action: "Enable Ruff TID252 rule in pre-commit hooks"

    - gap: "No documentation on where to put constants"
      lesson: "Developer uncertainty led to incorrect choice"
      action: "Add explicit guidance in CLAUDE.md § Python Import Policy"

  deployment_safety:
    - gap: "No post-deployment smoke tests"
      lesson: "Bug deployed to production without immediate detection"
      action: "Run golden path verification after each deployment"

related_incidents:
  - id: "RIS-069"
    title: "Tuple Unpacking ValueError"
    date: "2025-12-14"
    similarity: "Runtime error hidden as CORS error in browser"
    lesson: "Type-safe patterns prevent silent runtime failures"

related_sessions:
  - file: "sessions/20251214/SESSION-20251214-comprehensive-cme-topic-fix-COMPLETE.md"
    context: "SSOT implementation for CME topics"

  - file: "sessions/20251214/SESSION-20251214-FINAL-ssot-implementation-all-gaps-closed.md"
    context: "Large SSOT initiative with multiple changes"

prevention_success_criteria:
  immediate:
    - "✅ CME Harmonizer page loads without errors"
    - "✅ /api/v1/cme/compliance/harmonize returns 200"
    - "✅ No sys.path manipulation in runtime code"
    - "✅ CANONICAL_TOPICS in constants module"

  short_term:
    - "✅ Pre-commit rejects script imports from src/"
    - "✅ backend-validator explains import violations"
    - "✅ CLAUDE.md documents import policy"
    - "⏳ Integration tests cover harmonize endpoint"

  long_term:
    - "⏳ Zero script imports in src/ (verified by linter)"
    - "⏳ All new constants go to proper modules"
    - "⏳ Architecture docs guide developers"
    - "⏳ No repeat incidents of this anti-pattern"

metrics:
  code_quality:
    before:
      - script_imports_in_src: 1
      - sys_path_manipulations: 1
      - test_coverage_harmonize_endpoint: 0

    after:
      - script_imports_in_src: 0
      - sys_path_manipulations: 0
      - test_coverage_harmonize_endpoint: 100  # planned

  governance:
    before:
      - import_policy_documented: false
      - linting_rules_for_imports: false
      - skill_governance_strategy: false

    after:
      - import_policy_documented: true
      - linting_rules_for_imports: true
      - skill_governance_strategy: true

references:
  code:
    - "apps/backend-api/src/contexts/cme/constants.py (NEW)"
    - "apps/backend-api/src/core/services/cme_compliance_service.py:46-47"
    - "apps/backend-api/scripts/seed_cme_requirements.py:63-64"
    - "apps/backend-api/ruff.toml (NEW)"
    - ".pre-commit-config.yaml:61-66"

  documentation:
    - "CLAUDE.md § Python Import Policy (lines 396-473)"
    - "CLAUDE.md § When to Create Skills vs Pre-Commit Hooks (lines 103-137)"
    - ".claude/skills/backend-validator/SKILL.md:63-101"
    - "docs/kb/KB-005-python-import-anti-patterns.md (NEW)"

  tools:
    - "Ruff TID252 (flake8-tidy-imports banned-api)"
    - "Pre-commit hooks"
    - "backend-validator skill"

tags:
  - architecture
  - imports
  - python
  - production-outage
  - ssot
  - testing
  - governance

resolution_date: 2025-12-14
resolution_verified: true
recurrence_risk: low
