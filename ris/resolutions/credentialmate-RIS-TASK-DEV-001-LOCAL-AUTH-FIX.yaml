---
id: RIS-TASK-DEV-001-LOCAL-AUTH-FIX
title: Fix local dev login/signup failure (CORS + 500 errors)
created: 2025-11-29
updated: 2025-11-29
status: completed
priority: high
risk_level: low
phase: 7
owner: root
lane: backend
capsule: v10.0
classification: internal
soc2: true
iso27001: true

problem:
  description: |
    Local development environment login/signup endpoints returning 500 errors.
    Browser console showing CORS errors for auth endpoints.
    User unable to create accounts or log in via http://localhost:3000.

  symptoms:
    - POST /api/v1/auth/register returns HTTP 500 with 0-byte response
    - POST /api/v1/auth/login returns HTTP 500
    - Browser console: "CORS error - no Access-Control-Allow-Origin for http://localhost:3000"
    - Backend logs: "relation users does not exist"
    - UI shows: "Unable to connect to server. Please try again."

  scope: LOCAL development environment only (docker-compose setup)

  constraints:
    - NO production changes
    - NO AWS infrastructure changes
    - NO data loss (user confirmed no data to preserve)
    - Configuration changes only (no code changes preferred)

root_causes:
  - cause: AWS Secrets Manager enabled by default
    file: apps/backend-api/src/shared/infrastructure/secrets_manager.py
    line: 60
    detail: |
      AWS_SECRETS_MANAGER_ENABLED defaults to "true", causing backend to attempt
      boto3 connection to LocalStack on startup. This blocks app initialization
      and prevents auth endpoints from loading.

  - cause: Database password mismatch
    files:
      - apps/backend-api/.env.local (wrong credentials)
      - docker-compose.yml (authoritative source)
      - infra/docker/localstack-init/01-create-buckets.sh (LocalStack secrets)
    detail: |
      Backend .env.local used credmate_dev_pass / credmate_dev / port 5433
      Docker-compose.yml and LocalStack Secrets Manager use credmate_local_pass / credmate_local / port 5432
      This caused authentication failures once secrets manager was disabled.

  - cause: Missing database migrations
    detail: |
      Users table and other auth tables did not exist in credmate_local database.
      User confirmed "there is no data that needs to be preserved".
      Migrations needed to be run to create schema.

solution:
  approach: Minimal configuration-only fix

  changes:
    - file: apps/backend-api/.env.local
      modifications:
        - Added AWS_SECRETS_MANAGER_ENABLED=false (line 46)
        - Fixed DATABASE_URL password (credmate_dev_pass → credmate_local_pass)
        - Fixed DATABASE_URL database (credmate_dev → credmate_local)
        - Fixed DATABASE_URL port (5433 → 5432)
        - Fixed all related DB_* env vars to match docker-compose.yml
        - Fixed TEST_DATABASE_URL to match

  commands_executed:
    - docker restart credmate-backend-dev
    - docker exec credmate-backend-dev bash -c "cd /app/apps/backend-api && DATABASE_URL=postgresql://credmate_user:credmate_local_pass@postgres:5432/credmate_local alembic upgrade head"
    - docker exec credmate-postgres-local psql -U credmate_user -d credmate_local -c "\dt" | grep users

  migrations_run:
    count: 18
    final_revision: 20251128_1000
    tables_created:
      - users (auth)
      - organizations
      - providers
      - documents
      - audit_logs
      - sessions
      - cme_activities
      - notifications
      - (and 10+ more)

validation:
  tests_performed:
    - name: Health check
      command: curl http://localhost:8000/health
      result: SUCCESS - {"status":"healthy","service":"credmate-api"}

    - name: Auth register
      command: curl -X POST http://localhost:8000/api/v1/auth/register
      result: SUCCESS - 201 Created, JWT tokens returned

    - name: Auth login
      command: curl -X POST http://localhost:8000/api/v1/auth/login
      result: SUCCESS - 200 OK, JWT tokens returned

    - name: CORS configuration
      check: Backend logs show CORS origins
      result: SUCCESS - ['http://localhost:3000', 'http://127.0.0.1:3000']

    - name: Backend logs
      check: No AWS Secrets Manager errors
      result: SUCCESS - Clean startup, no boto3 crashes

    - name: Browser E2E
      status: USER CONFIRMED - "yes, that works"
      result: SUCCESS - User able to signup and login via browser

outcome:
  status: completed
  success: true
  time_to_resolution: ~15 minutes

  metrics:
    - Files modified: 1 (apps/backend-api/.env.local)
    - Lines changed: 11
    - Migrations run: 18
    - Endpoints fixed: 3 (health, register, login)
    - CORS errors: 0
    - 500 errors: 0

lessons_learned:
  what_worked:
    - Systematic investigation following TDD methodology
    - Checking LocalStack Secrets Manager as authoritative source
    - Using docker service name (postgres) instead of localhost for DB connection
    - Simple docker restart (not complex docker run command)
    - Reviewing previous session docs before implementing

  what_did_not_work:
    - Initial assumption that migrations weren't needed
    - Trying to run migrations before restarting container (old env vars still loaded)
    - Using localhost in DATABASE_URL inside container (should be 'postgres')

  what_made_it_easier:
    - User provided detailed analysis document with 3 root causes pre-identified
    - LocalStack Secrets Manager as single source of truth for credentials
    - Previous session docs (SESSION_20251127_PHASE12) showing migration patterns
    - TDD debugging methodology documentation
    - Existing docker-compose.yml with correct config

  what_made_it_harder:
    - .env.local credentials not aligned with docker-compose.yml
    - No clear documentation of local dev setup procedure
    - Container restart required to pick up new env vars (not obvious)
    - DATABASE_URL needed service name 'postgres' from inside container vs 'localhost' from host

  improvements_for_next_time:
    - Create KB runbook: "Local Dev Environment Setup from Scratch"
    - Add health check script that validates all env vars before starting
    - Consider docker-compose.override.yml for local dev overrides
    - Add .env.local.example with correct defaults
    - Document difference between host and container database URLs
    - Add pre-startup validation: check DB connection, check migrations status

technical_debt:
  items_not_addressed:
    - issue: PYTHONPATH for rules_engine module
      file: apps/backend-api/src/config/path_loader.py
      line: 59
      problem: Looks for docker-compose.dev.yml (doesn't exist)
      impact: Compliance/rules features may not work
      priority: medium
      reason_deferred: Not blocking auth, requires code change, user wanted minimal fix

    - issue: Local dev documentation gap
      problem: No comprehensive setup guide for new developers
      impact: Time wasted troubleshooting environment issues
      priority: high
      recommendation: Create docs/kb/runbooks/local_dev_setup.md

related:
  incidents:
    - RIS-INC-20251128-PROD-AUTH-LOGIN (PROD incident, different root causes)

  sessions:
    - SESSION-20251128-2245-prod-login-incident-docs
    - SESSION_20251127_PHASE12_UI_FIXES_DEPLOYMENT

  kb_entries:
    - docs/knowledge/TDD_DEBUGGING_METHODOLOGY.md
    - docs/knowledge/LOCALSTACK_S3_BROWSER_ACCESS.md
    - docs/runbooks/login-signup-golden-flow.md (to be created for local dev)

tags:
  - local-dev
  - auth
  - cors
  - database
  - migrations
  - docker
  - alembic
  - secrets-manager
  - troubleshooting
  - emergency-fix
