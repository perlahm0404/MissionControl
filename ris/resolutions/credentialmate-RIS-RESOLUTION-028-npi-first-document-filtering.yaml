---
resolution_id: RIS-RESOLUTION-028
title: NPI-First Provider Isolation for Document Access
status: implemented
priority: critical
date_created: 2025-12-02
date_resolved: 2025-12-02
category: security
lane: backend
risk_level: high

problem:
  description: |
    Document access endpoints (list, get, download, view) filtered by organization_id
    only, causing data bleed across providers within same organization. Dr. Sehgal
    (provider_id=15) could see documents from other providers in organization_id=14.

  impact:
    - HIPAA violation: Provider sees other providers' documents
    - Privacy breach: Multi-provider organizations share all data
    - Testing blocked: Cannot validate provider-isolated data
    - NPI-first architecture incomplete

  root_cause: |
    - Legacy organization-first data model
    - Document endpoints only checked organization_id
    - User.provider_id column existed but not used in queries
    - Dashboard endpoints already migrated, but document endpoints missed

solution:
  approach: NPI-First Filtering with Organization Fallback
  description: |
    Updated all document access endpoints to prioritize provider_id filtering
    when user has provider_id set, fallback to organization_id for backwards
    compatibility with organization-based accounts.

  implementation:
    endpoints_updated:
      - name: list_documents
        route: GET /api/v1/documents
        file: apps/backend-api/src/api/v1/documents.py
        lines: 237-266
        change: Provider-first base filter, org fallback

      - name: get_document
        route: GET /api/v1/documents/{document_id}
        file: apps/backend-api/src/api/v1/documents.py
        lines: 324-359
        change: Provider-first RLS filter

      - name: download_document
        route: GET /api/v1/documents/{document_id}/download
        file: apps/backend-api/src/api/v1/documents.py
        lines: 364-449
        change: Provider-first RLS filter

      - name: view_document (NEW)
        route: GET /api/v1/documents/{document_id}/view
        file: apps/backend-api/src/api/v1/documents.py
        lines: 452-515
        change: Provider-first RLS filter (built-in)

  code_pattern: |
    # NPI-FIRST: Build RLS (Row-Level Security) filter
    org_id = current_user.organization_id or current_user.id
    provider_id = getattr(current_user, 'provider_id', None)

    if provider_id:
        # Provider-level isolation (NPI-first)
        document_filter = [
            Document.id == document_id,
            Document.provider_id == provider_id
        ]
    else:
        # Organization-level (legacy fallback)
        document_filter = [
            Document.id == document_id,
            Document.organization_id == org_id
        ]

    # Query with RLS filter
    document = db.query(Document).filter(*document_filter).first()

  migration_status:
    phase_1_complete:
      - User model has provider_id column (migration 20251127_1400)
      - Dashboard endpoints (licenses, DEA, CSR) ✅
      - Document endpoints (list, get, download, view) ✅
      - Dr. Sehgal account configured (provider_id=15) ✅

    phase_2_remaining:
      - CME activities endpoints
      - Compliance endpoints
      - Organization management endpoints
      - Frontend provider selector UI
      - Real NPI validation (replace TEMP NPIs)

architecture_decision:
  model: Provider-First with Organization Fallback
  rationale: |
    - Medical credentialing is inherently provider-centric (not org-centric)
    - Each provider manages their own licenses, DEA, CME credits
    - Multi-provider practices need data isolation (HIPAA)
    - NPI (National Provider Identifier) is the industry standard
    - Backwards compatible with existing organization-based accounts

  filtering_logic:
    1. Check if user has provider_id set
    2. If yes: Filter by provider_id (provider-level isolation)
    3. If no: Filter by organization_id (legacy behavior)
    4. Never show data across providers in same org (privacy)

  trade_offs:
    pros:
      - HIPAA-compliant provider isolation
      - Matches medical credentialing reality
      - Backwards compatible (org-based users still work)
      - Scalable to multi-provider organizations
      - Future-proof for NPI enforcement

    cons:
      - Need to update all endpoints (in progress)
      - Dual filtering logic (complexity)
      - Migration required for existing data
      - Testing requires both org and provider accounts

validation:
  test_account:
    user_id: 15
    email: Real1@test.com
    organization_id: 14
    provider_id: 15

  test_results:
    dashboard_api:
      - endpoint: GET /api/v1/dashboard/credentials-summary?provider_id=15
      - before: Shows all providers in org 14
      - after: Shows only provider 15 data (24 licenses)
      - result: PASS ✅

    document_list:
      - endpoint: GET /api/v1/documents?provider_id=15
      - before: Shows all org 14 documents
      - after: Shows only provider 15 documents (37 CME PDFs)
      - result: PASS ✅

    document_download:
      - endpoint: GET /api/v1/documents/{id}/download
      - before: Any org 14 user could download any org doc
      - after: Only provider 15 can download their own docs
      - result: PASS ✅

lessons_learned:
  - Organization-first model doesn't match medical credentialing
  - Provider isolation must be enforced at database query level (RLS)
  - Incremental migration strategy prevents breaking existing users
  - Real user testing (Dr. Sehgal) exposed architectural issues
  - Dashboard vs document endpoint inconsistency caused data bleed

migration_guide:
  step_1_add_provider_id_column:
    - Migration already exists: 20251127_1400
    - Adds users.provider_id (nullable, indexed)
    - FK to providers table

  step_2_backfill_provider_id:
    - For provider-role users: UPDATE users SET provider_id = X WHERE role = 'provider'
    - For organization users: Leave provider_id NULL (fallback to org_id)

  step_3_update_endpoints:
    - Pattern: Check provider_id first, fallback to organization_id
    - Apply to ALL endpoints that access provider-specific data
    - Test with both provider-based and org-based accounts

  step_4_frontend_updates:
    - Add provider selector (if user has multiple providers)
    - Update API client to use provider_id filtering
    - Test isolation in browser

related:
  sessions:
    - SESSION-20251202-PNG-VIEWER-FIX-NPI-FIRST.md
    - SESSION-20251201-0430-real-user-setup-sehgal.md

  documents:
    - NPI-FIRST-ARCHITECTURE-ANALYSIS.md (full migration plan)

  patterns:
    - Row-Level Security (RLS) with provider isolation
    - Backwards-compatible filtering (provider-first, org fallback)
    - Incremental migration strategy (Phase 1, 2, 3)

  previous_resolutions:
    - RIS-RESOLUTION-024-multi-tier-sync-system.yaml (related to data isolation)

tags:
  - security
  - hipaa
  - provider-isolation
  - npi
  - rls
  - filtering
  - architecture
  - migration
  - backwards-compatibility

status: implemented
next_steps:
  - Complete Phase 2: Update remaining endpoints (CME, compliance)
  - Add real NPI validation via NPPES API
  - Test multi-provider organization scenarios
  - Add provider selector UI in frontend
  - Document NPI-first best practices for new endpoints
