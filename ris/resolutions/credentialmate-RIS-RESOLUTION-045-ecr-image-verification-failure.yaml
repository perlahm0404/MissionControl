ris_id: RIS-045
title: "ECR Image Verification Failure - Images Not Found After Successful Build"
date: 2025-12-11
status: INVESTIGATING
severity: HIGH
impact: PRODUCTION_DEPLOYMENT
category: CI_CD_INFRASTRUCTURE

---

## Problem Statement

After fixing the branch workflow migration issue (RIS-044), container builds now trigger automatically and complete successfully. However, deployments still fail at the "Verify ECR images exist" step with all images reported as NOT FOUND.

**Contradiction**:
- ✅ Container build #20155591445 succeeded
- ✅ Build logs show docker push commands executed
- ❌ Deployment verification can't find images with tag `90262ae`

**Error Output**:
```
Checking credmate-backend:90262ae...
✗ credmate-backend:90262ae NOT FOUND

Checking credmate-worker:90262ae...
✗ credmate-worker:90262ae NOT FOUND

Checking credmate-frontend:90262ae...
✗ credmate-frontend:90262ae NOT FOUND
```

## Current Status

**Container Build**:
- Workflow: `container-build.yml`
- Run ID: 20155591445
- Status: ✅ SUCCESS
- Event: `push` (automatic trigger - proof RIS-044 fix worked)
- Commit: `90262aee75c3208caa9e0ec3c57428c42d3c46f1`
- Short SHA: `90262ae`

**Deployment**:
- Workflow: `deploy-prod.yml`
- Run ID: 20155814954
- Status: ❌ FAILED
- Failure Point: "Verify ECR images exist"
- Looking For: `credmate-backend:90262ae`, `credmate-worker:90262ae`, `credmate-frontend:90262ae`

## Hypotheses

### Hypothesis 1: ECR Repository Naming Mismatch (MOST LIKELY)
**Theory**: Build pushes to one repository path, deployment searches a different path

**Possible Causes**:
- Build uses `credmate-backend`, deployment uses `credmate/backend`
- Build uses `<account>.dkr.ecr.us-east-1.amazonaws.com/credmate-backend`
- Deployment searches different registry or account

**Test**:
```bash
# Check what was actually pushed
gh run view 20155591445 --log | grep -A 10 "docker push"

# Check ECR repository list
aws ecr describe-repositories --region us-east-1

# Compare repository names
```

**Evidence**: None yet - need to investigate

### Hypothesis 2: Image Tag Format Mismatch
**Theory**: Build tags with one format, deployment searches for another

**Possible Causes**:
- Build uses full SHA `90262aee75c3208caa9e0ec3c57428c42d3c46f1`
- Deployment searches for short SHA `90262ae`
- Build adds prefix/suffix to tag

**Test**:
```bash
# Check what tags were actually created
gh run view 20155591445 --log | grep "docker tag"

# Check deployment search pattern
gh run view 20155814954 --log | grep "Checking credmate"
```

**Evidence**: Both build and deploy reference `90262ae` (short SHA), but need to verify actual tags created

### Hypothesis 3: AWS Region Mismatch
**Theory**: Images pushed to one region, deployment searches another

**Possible Causes**:
- Build uses `us-east-1`
- Deployment searches `us-west-2` or other region
- Environment variable override

**Test**:
```bash
# Check build region
gh run view 20155591445 --log | grep "aws-region"

# Check deployment region
gh run view 20155814954 --log | grep "region"
```

**Evidence**: Both workflows specify `us-east-1`, unlikely but should verify

### Hypothesis 4: AWS Authentication Timing Issue
**Theory**: Images exist but deployment can't authenticate to ECR to check

**Possible Causes**:
- OIDC token expired between build and deploy
- Different IAM roles for build vs deploy
- ECR permissions issue

**Test**:
```bash
# Check if ECR login succeeded in deployment
gh run view 20155814954 --log | grep -A 5 "Login to Amazon ECR"

# Check IAM role permissions
```

**Evidence**: Need to check deployment logs for authentication errors

### Hypothesis 5: Image Push Failed Silently
**Theory**: Docker push command ran but didn't actually succeed

**Possible Causes**:
- Network error during push (retry limit hit)
- ECR quota exceeded
- Image size too large

**Test**:
```bash
# Check build logs for push success confirmation
gh run view 20155591445 --log | grep -A 20 "docker push.*credmate-backend"

# Look for error messages after push
gh run view 20155591445 --log | grep -i "error\|failed" | grep -i push
```

**Evidence**: Build workflow reported success, but need to verify actual push output

## Investigation Plan

### Phase 1: Verify What Was Built (NEXT SESSION)
```bash
# 1. Check build logs for actual docker commands
gh run view 20155591445 --log > /tmp/build-logs.txt
grep -A 10 "docker build" /tmp/build-logs.txt
grep -A 10 "docker push" /tmp/build-logs.txt

# 2. Extract ECR repository names from build
grep "ECR_REGISTRY" /tmp/build-logs.txt
grep "dkr.ecr" /tmp/build-logs.txt

# 3. Check for push errors
grep -i "error\|failed\|denied" /tmp/build-logs.txt | grep -v "Failed to download"
```

### Phase 2: Verify ECR State
```bash
# 1. List all ECR repositories
aws ecr describe-repositories --region us-east-1 --output table

# 2. Check specific repositories for images
aws ecr describe-images --repository-name credmate-backend --region us-east-1 --max-items 10
aws ecr describe-images --repository-name credmate-worker --region us-east-1 --max-items 10
aws ecr describe-images --repository-name credmate-frontend --region us-east-1 --max-items 10

# 3. Search for images with this commit's tag
for REPO in credmate-backend credmate-worker credmate-frontend; do
  echo "Checking $REPO for tag 90262ae..."
  aws ecr describe-images --repository-name $REPO --region us-east-1 --image-ids imageTag=90262ae 2>&1 || echo "NOT FOUND"
done
```

### Phase 3: Compare Build vs Deployment
```bash
# 1. Extract deployment verification logic
gh run view 20155814954 --log > /tmp/deploy-logs.txt
grep -A 20 "Verify ECR images exist" /tmp/deploy-logs.txt

# 2. Compare registry URLs
# From build:
grep "dkr.ecr" /tmp/build-logs.txt | head -5
# From deploy:
grep "dkr.ecr" /tmp/deploy-logs.txt | head -5

# 3. Compare repository names
diff <(grep "credmate-" /tmp/build-logs.txt | grep -o "credmate-[a-z]*" | sort -u) \
     <(grep "credmate-" /tmp/deploy-logs.txt | grep -o "credmate-[a-z]*" | sort -u)
```

### Phase 4: Root Cause Confirmation
Based on findings from Phases 1-3, confirm root cause and implement fix.

## Expected Outcomes

### If Hypothesis 1 (Repository Naming)
**Fix**: Update deployment workflow to search correct repository paths
**File**: `.github/workflows/deploy-prod.yml`
**Change**: Update ECR repository references to match actual build output

### If Hypothesis 2 (Tag Format)
**Fix**: Align tag format between build and deployment
**Files**:
- `.github/workflows/container-build.yml` (build tags)
- `.github/workflows/deploy-prod.yml` (verification logic)

### If Hypothesis 3 (Region Mismatch)
**Fix**: Ensure consistent region across workflows
**Verification**: Add explicit region checks

### If Hypothesis 4 (Authentication)
**Fix**: Add ECR login step before image verification
**File**: `.github/workflows/deploy-prod.yml`

### If Hypothesis 5 (Silent Push Failure)
**Fix**: Add explicit error checking after docker push
**File**: `.github/workflows/container-build.yml`

## Temporary Workarounds

### Option 1: Manual Image Verification (NOT RECOMMENDED)
Skip automated verification, rely on manual checks:
```yaml
# .github/workflows/deploy-prod.yml
# Comment out verification step (RISKY)
# - name: Verify ECR images exist
```

**Risk**: Could deploy with missing/wrong images

### Option 2: Rebuild Images Just Before Deploy (SLOW BUT SAFE)
Always trigger fresh build right before deployment:
```bash
# Manual process
gh workflow run container-build.yml --ref main
# Wait for completion (~8 min)
gh workflow run deploy-prod.yml --ref main -f commit_sha=<sha> -f confirm_production=DEPLOY-TO-PRODUCTION
```

**Cost**: 8 extra minutes per deployment, duplicate builds

## Related Issues

- **RIS-044**: Branch workflow migration (FIXED - prerequisite for this issue)
- **SESSION-20251211-0800**: Debugging session where this issue was discovered

## Prevention Measures (To Be Added After Fix)

### 1. Pre-Push Verification in Build Workflow
```yaml
# .github/workflows/container-build.yml
- name: Verify images pushed successfully
  run: |
    for REPO in credmate-backend credmate-worker credmate-frontend; do
      aws ecr describe-images \
        --repository-name $REPO \
        --region us-east-1 \
        --image-ids imageTag=$SHORT_SHA || {
        echo "::error::Failed to verify $REPO:$SHORT_SHA was pushed"
        exit 1
      }
      echo "✓ Verified $REPO:$SHORT_SHA exists in ECR"
    done
```

### 2. Enhanced Deployment Verification
```yaml
# .github/workflows/deploy-prod.yml
- name: Verify ECR images exist (enhanced)
  run: |
    echo "Commit SHA: ${{ github.event.inputs.commit_sha }}"
    SHORT_SHA=$(echo ${{ github.event.inputs.commit_sha }} | cut -c1-7)
    echo "Short SHA: $SHORT_SHA"
    echo ""

    # Login to ECR first
    aws ecr get-login-password --region us-east-1 | \
      docker login --username AWS --password-stdin $ECR_REGISTRY

    # Check each image with detailed error reporting
    for REPO in credmate-backend credmate-worker credmate-frontend; do
      echo "Checking $REPO:$SHORT_SHA..."

      # Attempt to describe image
      IMAGE_INFO=$(aws ecr describe-images \
        --repository-name $REPO \
        --region us-east-1 \
        --image-ids imageTag=$SHORT_SHA 2>&1)

      if echo "$IMAGE_INFO" | grep -q "ImageNotFoundException"; then
        echo "::error::Image not found: $REPO:$SHORT_SHA"
        echo ""
        echo "Available tags in $REPO:"
        aws ecr describe-images --repository-name $REPO --region us-east-1 --max-items 5 --query 'imageDetails[*].imageTags' || true
        echo ""
        echo "Recent container builds:"
        gh run list --workflow=container-build.yml --limit 5 --json conclusion,createdAt,headSha || true
        exit 1
      fi

      echo "✓ Found $REPO:$SHORT_SHA"
    done
```

### 3. Build → Deploy Linking
Add metadata to build output that deployment can verify:
```yaml
# .github/workflows/container-build.yml
- name: Create build manifest
  run: |
    cat > build-manifest.json << EOF
    {
      "commit_sha": "${{ github.sha }}",
      "short_sha": "$SHORT_SHA",
      "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
      "images": [
        "$ECR_REGISTRY/credmate-backend:$SHORT_SHA",
        "$ECR_REGISTRY/credmate-worker:$SHORT_SHA",
        "$ECR_REGISTRY/credmate-frontend:$SHORT_SHA"
      ]
    }
    EOF

    # Upload to S3 or GitHub artifact
    aws s3 cp build-manifest.json s3://credmate-deploy-artifacts/builds/${{ github.sha }}.json

# .github/workflows/deploy-prod.yml
- name: Verify build manifest
  run: |
    # Download manifest
    aws s3 cp s3://credmate-deploy-artifacts/builds/${{ github.event.inputs.commit_sha }}.json manifest.json

    # Verify each image from manifest
    jq -r '.images[]' manifest.json | while read IMAGE; do
      echo "Verifying $IMAGE exists..."
      # Check ECR...
    done
```

## Timeline

- **2025-12-11 09:15**: Issue first discovered after RIS-044 fix
- **2025-12-11 09:20**: Investigation started, hypotheses formulated
- **Status**: BLOCKED - Awaiting detailed investigation

## Next Steps

1. ✅ Document issue (this RIS)
2. ✅ Create session file (SESSION-20251211-0800)
3. ✅ Create KB entry (deployment-troubleshooting-patterns.md)
4. ⏳ NEXT SESSION: Execute investigation plan Phase 1-3
5. ⏳ Identify root cause
6. ⏳ Implement fix
7. ⏳ Add prevention measures
8. ⏳ Update documentation

## Sign-Off

- **Discovered By**: Claude Code (SESSION-20251211-0800)
- **Status**: INVESTIGATING (blocked on next session)
- **Priority**: HIGH (blocking production deployments)
- **Target Resolution**: Next session (2025-12-11 or 2025-12-12)

---

**NOTE**: This RIS will be updated in the next session once investigation reveals root cause.
