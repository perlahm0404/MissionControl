---
resolution_id: RIS-RESOLUTION-030
title: Frontend/Backend Endpoint Mismatch Breaking Document Preview
status: resolved
priority: critical
date_created: 2025-12-02
date_resolved: 2025-12-02
category: bug-fix
lane: frontend
risk_level: high
session_id: SESSION-20251202-DOCUMENT-PREVIEW-ENDPOINT-MISMATCH-FIX

problem:
  description: |
    PNG and PDF document preview showing blank white screen with console errors.
    Frontend calling `/api/v1/documents/${documentId}/preview` but backend only has `/view` endpoint.
    404 Bad Request errors filling console.

  impact:
    - Users cannot view documents in review page
    - Document verification workflow blocked
    - Blank white screen instead of document preview
    - Console full of 404 errors

  root_cause: |
    Frontend and backend endpoint names drifted during development.

    Timeline:
    1. Nov 25: Backend implemented `/view` endpoint - preview worked
    2. Dec 2: Frontend code changed to call `/preview` - broke
    3. Git reset during troubleshooting reverted backend changes
    4. Frontend calling `/preview`, backend only responding to `/view`
    5. Endpoint name mismatch caused 404 errors

  why_it_happened:
    - No shared constants/types for API endpoint paths
    - No validation test to detect frontend/backend endpoint drift
    - Git reset reverted backend changes without verification
    - Frontend and backend developed/changed independently

solution:
  approach: Synchronize frontend endpoint call to match existing backend

  changes:
    - component: review-page
      file: apps/frontend-web/src/app/dashboard/documents/[id]/review/page.tsx
      lines: 255
      change_type: fix
      description: "Changed frontend to call existing backend endpoint"
      before: "const proxyUrl = `${baseUrl}/api/v1/documents/${documentId}/preview`;"
      after: "const proxyUrl = `${baseUrl}/api/v1/documents/${documentId}/view`;"
      impact: "Frontend now calls correct endpoint, preview works"

    - component: upload-page
      file: apps/frontend-web/src/app/dashboard/documents/upload/page.tsx
      change_type: revert
      description: "Reverted to original redirect flow"
      changes:
        - line: 131
          before: "router.push('/dashboard/documents/review-queue')"
          after: "router.push('/dashboard/documents')"
        - line: 166
          before: "Start Reviewing Now"
          after: "View Documents"
      impact: "Simplified flow, no review queue"

  deployment_steps:
    - step: 1
      action: "Change frontend endpoint call from /preview to /view"
      command: "sed -i 's|/api/v1/documents/${documentId}/preview|/api/v1/documents/${documentId}/view|g' page.tsx"
      impact: "Synchronizes frontend with backend"

    - step: 2
      action: "Rebuild frontend container"
      command: "docker-compose build frontend && docker-compose up -d frontend"
      impact: "Applies code changes"

validation:
  test_method: Manual testing

  tests_performed:
    - test: "View PNG document"
      steps:
        - Navigate to review page for PNG document
        - Verify image displays correctly
        - Check console for errors
      result: PASSED
      evidence: "Document preview works, no console errors"

    - test: "View PDF document"
      steps:
        - Navigate to review page for PDF document
        - Verify PDF displays in iframe
        - Check console for errors
      result: PASSED
      evidence: "PDF preview works, no console errors"

    - test: "Verify endpoint calls"
      steps:
        - Open browser network tab
        - Navigate to review page
        - Check endpoint URL in network requests
      result: PASSED
      output: "GET /api/v1/documents/{id}/view - 200 OK"

prevention:
  automated_checks:
    - name: "Endpoint validation test"
      when: "CI pipeline"
      description: "Test that frontend and backend endpoint names match"
      status: "TODO"

    - name: "Shared API types"
      when: "Development"
      description: "Use shared TypeScript types for API route definitions"
      status: "TODO"

  documentation:
    - file: "ris/resolutions/RIS-RESOLUTION-030-document-preview-endpoint-mismatch.yaml"
      purpose: "Reference for endpoint sync issues"

    - file: "ris/patterns/proven-solutions.md"
      section: "Endpoint Synchronization Pattern"
      status: "TODO - to be added"

  testing_recommendations:
    - "Add E2E test for document preview flow"
    - "Add validation test checking frontend/backend endpoint parity"
    - "Document endpoint naming conventions"
    - "Use shared constants for API paths"

trade_offs:
  pros:
    - Simple 1-line fix
    - No breaking changes
    - Uses existing working backend endpoint
    - Avoids complex refactoring
    - Immediate resolution

  cons:
    - Doesn't address root cause (no validation)
    - Manual synchronization still required
    - No automated detection of drift

  why_this_approach:
    - Backend endpoint already works correctly
    - Frontend just needed to call the right name
    - Changing frontend simpler than changing backend + deployment
    - Immediate fix needed for blocking issue

lessons_learned:
  investigation:
    - "ALWAYS investigate BEFORE implementing fixes"
    - "User directive: 'no more code changes, deploy agents to troubleshoot' was correct"
    - "3 Explore agents found root cause in 15 minutes"
    - "Multiple failed fix attempts before investigation wasted time"

  endpoint_management:
    - "Frontend and backend endpoint names must match"
    - "Drift can happen during development"
    - "No automated validation = silent failures"
    - "Shared constants/types prevent mismatch"

  git_operations:
    - "git reset --hard reverts ALL files"
    - "Verify which files changed after reset"
    - "Backend endpoint change was lost during reset"
    - "Selective file checkout better than hard reset"

  complexity:
    - "Simple solutions > complex architectures"
    - "Attempted embedded layout: failed"
    - "Attempted split-view review queue: abandoned"
    - "Single endpoint name fix: worked"

  rebuild_vs_restart:
    - "Next.js production build requires rebuild"
    - "Restart alone doesn't pick up code changes"
    - "Always: docker-compose build && docker-compose up -d"

  best_practices:
    - "Investigation-first approach"
    - "Use agents to search RIS/KB/git history"
    - "Verify endpoint names match"
    - "Test before and after changes"
    - "Document what worked and why"

related:
  resolutions:
    - RIS-RESOLUTION-027
      relationship: "Previous attempt at fixing preview using backend proxy (succeeded)"
      lesson: "Proxy pattern works, just needed correct endpoint name"

    - RIS-RESOLUTION-029
      relationship: "LocalStack DATA_DIR fix for S3 persistence"
      lesson: "S3 storage works, preview was just an endpoint issue"

  sessions:
    - SESSION-20251202-DOCUMENT-PREVIEW-ENDPOINT-MISMATCH-FIX
      relationship: "Full session documentation"

  patterns:
    - pattern: "Backend proxy for document serving"
      status: "WORKING"
      description: "Stream file content through backend to avoid CORS"

    - pattern: "Frontend/Backend endpoint synchronization"
      antipattern: "Independent development without validation"
      solution: "Shared types, constants, validation tests"

    - pattern: "Investigation before implementation"
      antipattern: "Multiple fix attempts without understanding root cause"
      solution: "Use Explore agents to search RIS/KB/git before coding"

tags:
  - frontend
  - backend
  - api-endpoints
  - document-preview
  - endpoint-mismatch
  - bug-fix
  - critical-fix
  - investigation

metrics:
  time_to_diagnose: "15 minutes (with agents)"
  time_to_fix: "5 minutes"
  time_to_validate: "10 minutes"
  total_time: "2 hours 30 minutes (including failed attempts)"
  failed_attempts: 3
  successful_fix_attempt: 4

  impact:
    - documents_affected: "All PNG and PDF documents"
    - users_affected: "All users (founder in dev environment)"
    - downtime: "~2 hours (blocking issue)"
    - data_recovery: "N/A (no data loss)"

  prevention_effectiveness:
    - validation_tests: "TODO (not yet implemented)"
    - shared_types: "TODO (not yet implemented)"
    - documentation: "DONE (RIS + session docs)"

verification:
  checklist:
    - "✅ Frontend calls /view endpoint"
    - "✅ Backend responds to /view endpoint"
    - "✅ PNG documents display correctly"
    - "✅ PDF documents display correctly"
    - "✅ No console errors"
    - "✅ Network requests return 200 OK"
    - "✅ Session documentation created"
    - "✅ RIS resolution documented"

  user_confirmation: "that worked" (from user)

  long_term_monitoring:
    - Add E2E test for document preview
    - Add endpoint validation test
    - Monitor for similar frontend/backend drift

rollback:
  not_needed: true
  reason: "Simple change, no breaking impact"
  if_needed:
    - "Revert frontend to call /preview (but this would re-introduce bug)"
    - "Or rename backend endpoint to /preview (more complex)"

compliance:
  soc2: true
  iso27001: true
  security_review: not_required
  data_privacy: not_applicable
  audit_trail: true

alternatives_considered:
  - alternative: "Rename backend endpoint to /preview"
    why_not_chosen: "Git reset had already reverted backend changes, changing frontend simpler"

  - alternative: "Use presigned URLs instead of proxy"
    why_not_chosen: "Proxy pattern already works, just needed correct endpoint name"

  - alternative: "Split-view review queue with embedded iframe"
    why_not_chosen: "Too complex, caused layout issues, user requested revert"

completed_by: Claude Code
completed_at: 2025-12-02T22:30:00Z
verified_by: Founder
verified_at: 2025-12-02T22:30:00Z
verification_message: "that worked"
