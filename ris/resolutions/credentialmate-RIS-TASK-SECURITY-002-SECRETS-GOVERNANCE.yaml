---
task_id: RIS-TASK-SECURITY-002-SECRETS-GOVERNANCE
title: Secrets Governance Audit and Harmonization
version: 1.0.0
owner: governance
classification: confidential
soc2: true
iso27001: true
context: security
created: 2025-11-27 00:00:00 UTC
last_modified: 2025-11-27 00:00:00 UTC
capsule: v1.8.2
governed_by_capsule: v1.8.2
status: completed
---

# RIS-TASK-SECURITY-002: Secrets Governance Audit and Harmonization

**Lane**: Security + Infra
**Risk**: HIGH
**Created**: 2025-11-27
**Status**: COMPLETED
**Owner**: Claire Orchestrator (Security Lane)

---

## Executive Summary

Comprehensive secrets governance audit completed across local dev and AWS production environments. Discovered and classified 6 `.env` files, 1 CRITICAL plaintext AWS credential violation, and validated secrets loading architecture. Harmonization plan created with enforcement automation.

**CRITICAL FINDING**: ⚠️ **AWS production credentials stored in plaintext** in `.env` (root) - IMMEDIATE ACTION REQUIRED

---

## Audit Results

### 1. Secrets Discovery

**Total Secret Files Found**: 6

| File | Classification | Risk | Contains |
|------|---------------|------|----------|
| `.env` | ⚠️ **CRITICAL VIOLATION** | HIGH | AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY (PROD) |
| `.env.local.template` | ✅ Safe (template) | LOW | Templates with placeholders |
| `.env.example` | ✅ Safe (template) | LOW | Example configuration |
| `apps/backend-api/.env.local` | ✅ Safe (dev) | LOW | Local dev secrets (LocalStack) |
| `apps/worker-tasks/.env.local` | ✅ Safe (dev) | LOW | Local dev secrets (LocalStack) |
| `apps/frontend-web/.env.local` | ✅ Safe (dev) | LOW | Frontend environment URLs |

**AWS Credentials Discovery**:
- ⚠️ **CRITICAL**: `.env` contains REAL AWS credentials (AKIAQYEI4XNCJPXTSCNY)
- ✅ SAFE: All `.env.local` files use LocalStack test credentials

**Test Tokens Discovery**:
- `.env.local.template` contains 4 expired JWT test tokens (safe - expired)
- All tokens marked as reference-only

---

### 2. Secrets Loading Architecture

**Backend API** ([config.py:92-187](apps/backend-api/src/shared/infrastructure/config.py#L92-L187)):
```
Precedence:
1. AWS Secrets Manager (production) → credmate/{env}/{type}
2. Environment variables (local dev) → .env.local
3. Defaults (fallback)

Control Flag: AWS_SECRETS_MANAGER_ENABLED (default: true)
```

**Worker Tasks** ([celery_app.py:49-52](apps/worker-tasks/src/celery_app.py#L49-L52)):
```
Loads from environment variables:
- REDIS_HOST, REDIS_PORT, REDIS_DB
- No Secrets Manager integration yet
```

**Secrets Manager Client** ([secrets_manager.py:32-222](apps/backend-api/src/shared/infrastructure/secrets_manager.py#L32-L222)):
```
Features:
- ✅ Singleton pattern with 5-minute cache
- ✅ LocalStack support for dev
- ✅ Fallback to environment variables when AWS_SECRETS_MANAGER_ENABLED=false
- ✅ Error handling with specific exception types
```

**Secret Types Managed**:
1. `credmate/{env}/database` - PostgreSQL credentials
2. `credmate/{env}/jwt` - JWT signing keys
3. `credmate/{env}/redis` - Redis connection
4. `credmate/{env}/encryption` - Master encryption key + KMS
5. `credmate/{env}/anthropic` - Anthropic API key

---

### 3. Drift Detection

**CRITICAL VIOLATIONS**:
1. ⚠️ **Plaintext AWS credentials in `.env`** (root)
   - File: `.env`
   - Contains: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
   - Action: IMMEDIATE ROTATION + REMOVAL

**MEDIUM RISK**:
2. ⚠️ **Duplicate secret definitions** across 3 `.env.local` files
   - `apps/backend-api/.env.local`
   - `apps/worker-tasks/.env.local`
   - `apps/frontend-web/.env.local`
   - Resolution: Consolidate into single root `.env.local`

**LOW RISK**:
3. ✅ **No secrets in JSON/YAML** - all Terraform variables externalized
4. ✅ **No hardcoded API keys** in Python/TypeScript source
5. ✅ **All `.env*` files in .gitignore** - verified

**ZOMBIE SECRETS**:
- `.env.example` - outdated template (superseded by `.env.local.template`)
- Action: Archive to zdelete/

---

### 4. .gitignore Validation

**Status**: ✅ COMPLIANT

Protected patterns:
```
.env
.env.local
.env.*.local
*.tfvars
.claude/settings.local.json
```

**Coverage**:
- ✅ All `.env` variants ignored
- ✅ Terraform tfvars ignored
- ✅ Claude settings ignored
- ✅ No exceptions that expose secrets

---

## Harmonization Plan

### Canonical Secret Locations

**Environment-Based Strategy**:

| Environment | Secrets Location | Control Flag |
|-------------|-----------------|--------------|
| **Local Dev** | `.env.local` (root) | `AWS_SECRETS_MANAGER_ENABLED=false` |
| **Docker Local** | `.env.local` per app | (current state - to consolidate) |
| **CI/CD** | `.env.test` (gitignored) | Test credentials |
| **AWS Staging** | AWS Secrets Manager | `credmate/staging/*` |
| **AWS Production** | AWS Secrets Manager | `credmate/prod/*` |

**Naming Standards**:
```
Local Dev:
- DATABASE_URL, DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD
- JWT_SECRET_KEY, JWT_ALGORITHM
- REDIS_HOST, REDIS_PORT
- ENCRYPTION_MASTER_KEY
- ANTHROPIC_API_KEY
- AWS_ACCESS_KEY_ID (optional - only for LocalStack)

Production (AWS Secrets Manager):
- credmate/prod/database
- credmate/prod/jwt
- credmate/prod/redis
- credmate/prod/encryption
- credmate/prod/anthropic
```

---

## CRITICAL Action Items

### Immediate (HIGH RISK)

**1. Rotate Compromised AWS Credentials**
```bash
# Step 1: Create new IAM user with same permissions
aws iam create-user --user-name credmate-dev-new

# Step 2: Attach policies
aws iam attach-user-policy \
  --user-name credmate-dev-new \
  --policy-arn arn:aws:iam::aws:policy/YOUR_POLICY

# Step 3: Generate new access key
aws iam create-access-key --user-name credmate-dev-new

# Step 4: Test new credentials
export AWS_ACCESS_KEY_ID=<new_key>
export AWS_SECRET_ACCESS_KEY=<new_secret>
aws sts get-caller-identity

# Step 5: Update .env.local (NOT .env)
echo "AWS_ACCESS_KEY_ID=<new_key>" >> .env.local
echo "AWS_SECRET_ACCESS_KEY=<new_secret>" >> .env.local

# Step 6: Delete old credentials
aws iam delete-access-key \
  --user-name credmate-dev \
  --access-key-id AKIAQYEI4XNCJPXTSCNY

# Step 7: Remove .env file
git rm --cached .env
echo ".env" >> .gitignore
```

**Status**: ⚠️ PENDING HUMAN APPROVAL (cannot auto-execute credential rotation)

**2. Remove `.env` from Repository**
```bash
# Already gitignored, but exists in working directory
# Auto-executed: NO (requires human review of contents first)
```

---

### Medium Priority

**3. Consolidate `.env.local` Files**

**Current State** (3 separate files):
- `apps/backend-api/.env.local` (78 lines)
- `apps/worker-tasks/.env.local` (71 lines)
- `apps/frontend-web/.env.local` (40 lines)

**Target State** (1 root file):
- `.env.local` (root) - consolidated secrets
- Apps load from root via environment

**Migration**:
```bash
# Auto-execute: YES (low risk, nondestructive)
# Merge all three into root .env.local
# Remove app-specific .env.local files
# Update docker-compose.dev.yml to mount root .env.local
```

**4. Archive Obsolete Templates**
```bash
# Move .env.example to zdelete/
git mv .env.example zdelete/env-example-archived-2025-11-27.txt
```

---

## Automation Created

### 1. Secrets Governance Hook

Created: `.claude/commands/secrets-governance.md`

**Enforcement Rules**:
- ❌ No plaintext secrets in repo (except `.env.local`)
- ❌ No secrets in JSON/YAML unless encrypted
- ❌ Local dev → `.env.local` only
- ❌ Prod → AWS Secrets Manager only
- ⚠️ Warning if user asks to create new AWS key
- ⚠️ Confirmation for IAM role/key creation

**Auto-Triggers**:
- `/boot` - precheck secrets before session start
- `/claire` - validate secrets governance
- Troubleshooting hook - detect secret leaks

---

### 2. Secrets Registry (Already Exists)

Validated: [docs/kb/security/secret-registry.md](docs/kb/security/secret-registry.md)

**Status**: ✅ UP TO DATE
- Contains all 5 secret types
- Terraform references correct
- Code references valid
- Rotation schedules documented

---

### 3. KB Documentation

Created: [docs/kb/security/secrets_management_v1.8.2.md](docs/kb/security/secrets_management_v1.8.2.md)

**Contents**:
- Secrets loading architecture diagram
- Local dev vs production patterns
- Drift detection procedures
- Harmonization playbook
- Emergency rotation runbook

---

## Compliance Impact

### SOC2 CC6.1 (Credential Management)
- ⚠️ **FINDING**: Production credentials in plaintext (`.env`)
- ✅ **MITIGATION**: Immediate rotation + removal plan
- ✅ **EVIDENCE**: This RIS task + rotation audit trail

### HIPAA 164.308(a)(4) (Information Access Management)
- ✅ **COMPLIANT**: Secrets Manager with CloudTrail logging (prod)
- ⚠️ **GAP**: Local dev credentials not centrally managed
- ✅ **MITIGATION**: Developer onboarding enforces `.env.local` template

### ISO 27001 A.9.4.3 (Password Management System)
- ✅ **COMPLIANT**: Centralized secret storage (Secrets Manager)
- ✅ **COMPLIANT**: Encryption at rest (KMS)
- ⚠️ **FINDING**: `.env` plaintext storage
- ✅ **MITIGATION**: Rotation + enforcement hook

---

## Monitoring & Enforcement

### Current State
- ✅ `.gitignore` prevents accidental commit
- ✅ Secrets Manager client validates format
- ✅ Environment-based loading precedence

### Proposed Automation (Post-This Task)
1. **Pre-commit hook**: Scan for plaintext secrets
2. **CI/CD check**: Validate no secrets in code
3. **Secrets rotation alarm**: CloudWatch alert at 85 days
4. **Drift detection**: Monthly audit script

---

## Testing & Validation

### Validation Commands

**1. Verify secrets loading (local dev)**:
```bash
cd apps/backend-api
export AWS_SECRETS_MANAGER_ENABLED=false
python -c "from src.shared.infrastructure.config import get_config; print(get_config().database.connection_string)"
```

**2. Verify secrets loading (AWS)**:
```bash
export AWS_SECRETS_MANAGER_ENABLED=true
export ENVIRONMENT=prod
aws secretsmanager get-secret-value --secret-id credmate/prod/database
```

**3. Test fallback behavior**:
```bash
# Disable Secrets Manager, should fallback to env vars
export AWS_SECRETS_MANAGER_ENABLED=false
export DB_HOST=localhost
python apps/backend-api/src/main.py  # Should start successfully
```

---

## Related Documentation

**Application Code**:
- [Secrets Manager Client](apps/backend-api/src/shared/infrastructure/secrets_manager.py)
- [Configuration Loader](apps/backend-api/src/shared/infrastructure/config.py)
- [Environment Mode Detector](apps/backend-api/src/config/env_mode.py)

**Terraform**:
- [Secrets Module](infra/terraform/modules/secrets/main.tf)
- [KMS Module](infra/terraform/modules/kms/main.tf)
- [IAM Policies](infra/terraform/modules/iam/main.tf)

**Governance**:
- [Secret Registry](docs/kb/security/secret-registry.md)
- [Secrets Management v1.8.2](docs/kb/security/secrets_management_v1.8.2.md)
- [Settings Cleanup](docs/kb/security/settings_cleanup.md)

---

## Change Log

| Date | Change | Author | Status |
|------|--------|--------|--------|
| 2025-11-27 | Initial secrets governance audit | Claire (Security Lane) | COMPLETED |
| 2025-11-27 | Discovered CRITICAL plaintext AWS credentials | Claire (Security Lane) | ACTION REQUIRED |
| 2025-11-27 | Created harmonization plan | Claire (Security Lane) | APPROVED |
| 2025-11-27 | Created enforcement hook | Claire (Security Lane) | INSTALLED |

---

## Next Steps

**CRITICAL (Immediate)**:
1. ⚠️ Rotate AWS credentials in `.env`
2. ⚠️ Remove `.env` from working directory (keep `.env.local` only)
3. ⚠️ Verify no additional credential exposure

**HIGH (This Sprint)**:
4. Consolidate `.env.local` files into root
5. Update docker-compose.dev.yml to mount root `.env.local`
6. Archive `.env.example`

**MEDIUM (Next Sprint)**:
7. Implement pre-commit secret scanning hook
8. Add CloudWatch alarms for secret rotation
9. Create drift detection automation

---

## Approval & Sign-Off

**Security Lane**: ✅ Approved (automated - low/medium risk items)
**Infra Lane**: ⚠️ Pending (AWS credential rotation)
**Compliance**: ⚠️ Pending (SOC2 auditor review of `.env` exposure)

**Human Approval Required For**:
- AWS credential rotation
- Removal of `.env` file from working directory
