---
event_type: governance_patch
id: RIS-TASK-GOV-AGENT-DELEGATION-V1.1
created_at: "2025-12-01T00:00:00Z"
completed_at: "2025-12-01T02:00:00Z"
status: completed
priority: high
classification: internal
capsule: v10.0
---

# RIS TASK: Governance Patch - Agent Delegation v1.1

## Summary
Apply Agent Delegation v1.1 governance patch based on smoke test findings to enforce:
1. Automatic proper-fix selection for non-high-risk work (no A/B/C menus)
2. Strict TDD (test-first) across auth, parser, backend, worker, data lanes
3. Explicit backend, infra, and service-agent routing + approval rules
4. Strengthened RIS + git-based change tracking with concrete examples

## Scope
Governance files updated:
- docs/governance/active/capsule-v10.0.md
- docs/governance/active/agent-contracts-v10.0.yaml
- docs/knowledge/kb/governance/claire-agent-routing-v1.0.md
- agents/services/parser-builder.yaml
- agents/services/auth-flow-guardian.yaml
- agents/services/infra-guardian.yaml (verified, no changes needed)

## Source Truth
Smoke test reports analyzed:
- agent-refactor-smoke-test-ns.md (agent delegation test v1.0)
- ris/sessions/AGENT-ROUTING-DIAGNOSTIC-20251130.md (/claire diagnostic)

## Changes Applied

### 1. Capsule v10.0 Updates
**TAM Decision Policy (Section 15.2.1)**:
- Non-high-risk (low/medium): auto-select proper fix, NO options menus, NO user approval
- High/critical risk: human chooses, agents present options with risk analysis, explicit approval required

**Global TDD Workflow Enforcement (Section 9.2)**:
- Required lanes: auth, parser, backend, worker, data
- Mandatory workflow: write failing test → confirm fail → fix code → confirm pass → run full suite
- EXPLICITLY FORBIDDEN: write tests after fixing code, skip test-first sequence
- Applies to: bug fixes, parser drift, auth changes, backend API, worker tasks, data schema

**RIS Clarification (Section 10.3, 10.3.1)**:
- RIS NOT required: truly minor, single-file, <50 LOC dev fixes with NO API contract changes
- RIS required/recommended: medium-risk backend/parser/auth, cross-provider, cross-lane (COORD-RIS)

### 2. Agent-Contracts v10.0 Updates
**Global Rules**:
- Added: "For non-high-risk work (low/medium), agents MUST auto-select proper fix WITHOUT offering fast vs proper choice menus"
- Added: "Only pause for human approval on high/critical risk tasks"
- Added: "Agents must NOT present A/B/C option menus for low/medium-risk work"

**TDD Enforcement Blocks**:
- parser (lane): Added tdd_workflow with mandatory mode, explicit sequence, forbidden actions
- backend (lane): Added tdd_workflow for regression tests, approval_required extended (schema_changes, api_contract_changes, auth_logic_changes_production)

**Change Tracking Examples**:
- auth-flow-guardian: commit_example with Agent + RIS footer
- parser-analyst: commit_example with Delegated-To footer
- parser-builder: commit_example with Delegated-From footer
- backend: commit_example with regression test mention
- infra-guardian: commit_example with Environment + Approval fields

### 3. Claire-Agent-Routing v1.0 Updates
**Backend API Bug Rule (Section 2.1)**:
- When: API route 4xx/5xx, business-logic bug, middleware issue
- Agent: backend
- TDD required: true
- Risk: medium (dev auto-approve, prod Sentinel review)
- Workflow: write failing regression test → fix → verify → run full suite

**Backend + Infra Overlap Rule (Section 2.4)**:
- When: backend needs AWS resource changes (RDS, S3, IAM, etc.)
- Process: backend → Claire → COORD-RIS → infra-guardian (infra) → backend (app code) → Claire merge
- Example: "Backend needs increased RDS connection pool"

**Behavior Section (Section 2.2.1)**:
- Low/medium risk: auto proper-fix, NO options menus, user approval NOT required
- High/critical risk: options with risk analysis, user MUST approve, agents wait

### 4. Agent YAML Updates
**parser-builder.yaml**:
- Added tdd_workflow block: mode=mandatory, sequence (receive drift → write test → confirm fail → fix → confirm pass → full suite)
- Explicitly forbidden: tests after code, skip test-first
- Rationale: test-first ensures tests catch real drift

**auth-flow-guardian.yaml**:
- Added tdd_workflow block: mode=mandatory, sequence (run synthetic tests → identify failures → propose fix → apply → re-run → report metrics)
- Explicitly forbidden: fix before tests, skip verification
- Rationale: synthetic tests ARE the TDD suite for auth
- Test suite: tests/smoke/login_smoke_test.py

**infra-guardian.yaml**:
- VERIFIED: production environment_rules already correct
  - autonomy: plan_only
  - mutations_allowed: false
  - destructive_commands_blocked: true
  - terraform_apply_blocked: true
  - requires_ris: true

## Governance Gaps Addressed
All 5 gaps from agent-refactor-smoke-test-ns.md resolved:
1. ✅ Parser TDD rules now explicit in parser-builder.yaml
2. ✅ Fast vs proper fix prohibition in global rules
3. ✅ Auth-flow-guardian TDD workflow added
4. ✅ RIS optional/required clarified in Capsule Section 10.3/10.3.1
5. ✅ Backend+infra overlap routing added to claire-agent-routing-v1.0.md

## Verification Plan
Re-run Agent Delegation Smoke Test v1.0 with same 4 scenarios:
- Scenario A: Parser drift (dev) → verify TDD workflow, no options menus
- Scenario B: Auth failure (dev) → verify synthetic test TDD workflow, auto-approve
- Scenario C: Infra incident (prod) → verify PLAN-ONLY, human approval, RIS required
- Scenario D: Backend API bug (dev) → verify regression test TDD, auto-approve

Expected confirmation in smoke test report:
- ✅ No fast/proper "options" offered for low/medium-risk work
- ✅ TDD always test-first for auth/parser/backend scenarios
- ✅ All RIS + commit examples include actor_agent_id and agent names

## Impact Assessment
**Risk Level**: LOW (governance documentation only, no code changes)

**Approval**: Not required (governance refinement, non-breaking)

**Backward Compatibility**: Fully backward compatible (clarifies existing intent)

**Affected Agents**: All agents (governance applies universally)

## Rollback Plan
If governance patch causes issues:
1. git revert commit
2. Restore previous governance file versions from git history
3. Document issue in RIS-INC entry

## Next Steps
1. Create PR with all governance changes
2. Merge PR after review
3. Run Agent Delegation Smoke Test v1.0 for verification
4. Update session summary with results
5. Move RIS task to completed/

## Related Documents
- Smoke Test (NS): agent-refactor-smoke-test-ns.md
- Smoke Test (/claire): ris/sessions/AGENT-ROUTING-DIAGNOSTIC-20251130.md
- Capsule: docs/governance/active/capsule-v10.0.md
- Agent Contracts: docs/governance/active/agent-contracts-v10.0.yaml
- Claire Routing: docs/knowledge/kb/governance/claire-agent-routing-v1.0.md

## Metadata
- **Actor**: Claire
- **Session**: SESSION-20251201-[CURRENT]
- **Environment**: local
- **Change Type**: governance
- **Files Modified**: 5 governance files
- **Approval Required**: NO (governance refinement)
- **RIS Required**: YES (governance patch)
