# RIS Resolution: Production Hardcoded Image Tags Fix
# ID: RIS-081
# Created: 2025-12-20
# Status: RESOLVED

id: RIS-081
title: "Production Deployment Fails Due to Hardcoded Image Tags"
created: 2025-12-20
resolved: 2025-12-20
severity: HIGH
category: infrastructure
status: RESOLVED

# Problem Statement
problem: |
  Production deployments were pulling stale Docker images even after pushing new
  images to ECR and running docker-compose pull. Containers showed old commit SHAs
  (e.g., 3229fc3) instead of the newly deployed SHA (e.g., bb6a369).

# Root Cause Analysis
root_cause: |
  Production docker-compose.yml on EC2 uses HARDCODED image tags like:
    image: ${ECR_REGISTRY}/credmate-backend:abc1234

  The ${VERSION} environment variable is NOT referenced in the production file.
  Setting `export VERSION=bb6a369` has no effect because the tag is literal.

  docker-compose pull only fetches what's specified in the file, which is the
  old hardcoded tag that already exists locally.

# Discovery
discovery:
  date: 2025-12-20
  trigger: "Production deployment of commit bb6a369"
  symptoms:
    - "docker ps shows old image tags (3229fc3) after deployment"
    - "New code not running despite successful push to ECR"
    - "Health check passes but features from new commit missing"
  misleading_signals:
    - "Migration error 'No script_location key found' was a red herring"
    - "This error occurs when DB is already at head, not a real failure"

# Solution
solution:
  approach: "Use sed to update hardcoded tags before docker-compose pull"
  implementation: |
    Added to deploy-direct.sh SSM commands:
    ```bash
    sed -i "s/credmate-backend:[a-f0-9]\{7\}/credmate-backend:$SHORT_SHA/g" docker-compose.yml
    sed -i "s/credmate-worker:[a-f0-9]\{7\}/credmate-worker:$SHORT_SHA/g" docker-compose.yml
    sed -i "s/credmate-frontend:[a-f0-9]\{7\}/credmate-frontend:$SHORT_SHA/g" docker-compose.yml
    ```
  files_modified:
    - path: "infra/scripts/deploy-direct.sh"
      change: "Added sed commands, --rebuild flag, fixed build context"
    - path: ".claude/skills/deploy-to-production/SKILL.md"
      change: "Added architecture explanation and known issues"

# Verification
verification:
  steps:
    - "Run: bash infra/scripts/deploy-direct.sh --rebuild"
    - "Verify image tags in production: grep 'credmate-' docker-compose.yml"
    - "Check containers: docker ps --format 'table {{.Names}}\t{{.Image}}'"
    - "Confirm health: curl https://api.credentialmate.com/health"
  test_date: 2025-12-20
  result: PASSED

# Prevention
prevention:
  - action: "deploy-direct.sh now includes sed commands automatically"
    status: IMPLEMENTED
  - action: "Skill documentation updated with architecture explanation"
    status: IMPLEMENTED
  - action: "Consider switching to ${VERSION} variable in production"
    status: FUTURE
    reason: "Would require updating EC2 .env file on each deploy"

# Related
related:
  session: "sessions/20251220/SESSION-20251220-PRODUCTION-DEPLOYMENT-HARDCODED-TAGS.md"
  kb: "docs/kb/PRODUCTION-DEPLOYMENT-ARCHITECTURE.md"
  skill: ".claude/skills/deploy-to-production/SKILL.md"
  script: "infra/scripts/deploy-direct.sh"

# Tags
tags:
  - production
  - deployment
  - docker
  - ecr
  - infrastructure
  - hardcoded-values
