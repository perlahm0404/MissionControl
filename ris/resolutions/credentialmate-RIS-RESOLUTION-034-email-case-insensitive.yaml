---
resolution_id: RIS-RESOLUTION-034
title: Case-Insensitive Email Registration and Login
status: resolved
priority: critical
date_created: 2025-12-08
date_resolved: 2025-12-08
category: security
lane: backend

problem:
  description: |
    Email registration was case-sensitive, allowing "John@email.com" and "john@email.com"
    to register as separate user accounts. This caused login failures, account confusion,
    and potential security bypasses for org membership checks.
  root_cause: |
    No email normalization at application layer. PostgreSQL UNIQUE constraint is
    case-sensitive by default. Pydantic EmailStr validates format but doesn't normalize case.

solution:
  approach: Defense-in-depth - normalize at schema, service, and database layers
  files_changed:
    - apps/backend-api/src/contexts/auth/schemas/auth_schemas.py: Added @field_validator('email') to RegisterRequest, LoginRequest
    - apps/backend-api/src/contexts/auth/services/auth_service.py: Added email.strip().lower() in login()
    - apps/backend-api/src/contexts/organization/schemas/organization_schemas.py: Added @field_validator('email') to InviteMemberRequest
    - apps/backend-api/src/contexts/auth/utils/email_utils.py: Created normalize_email() utility
    - apps/backend-api/alembic/versions/20251208_2330_email_case_insensitive.py: Migration for LOWER() index
    - apps/backend-api/tests/e2e/auth/test_auth_flow.py: Added 2 case-insensitive tests
  code_pattern: |
    @field_validator('email', mode='after')
    @classmethod
    def normalize_email(cls, v: str) -> str:
        return v.strip().lower() if v else v

validation:
  method: E2E tests - test_duplicate_email_case_insensitive_returns_409, test_login_case_insensitive
  result: pass

lessons_learned:
  - Always normalize identifiers (email, username) to lowercase at input boundary
  - PostgreSQL UNIQUE constraints are case-sensitive - use LOWER() functional index for case-insensitivity
  - Defense-in-depth: normalize at multiple layers (schema, service, database)

tags:
  - auth
  - security
  - email
  - case-sensitivity
  - deduplication

related:
  session: SESSION-20251208-2330-username-dedup-case-insensitive
---
