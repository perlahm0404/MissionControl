---
resolution_id: RIS-RESOLUTION-041
title: Production Pipeline Silent Failures - Fail-Fast Validation
status: resolved
priority: critical
date_created: 2025-12-11
category: bug
lane: all

problem:
  description: |
    The golden path (upload→parse→extract→view) works in local dev but has silent failures in production.
    Users see infinite spinners with no error messages. Critical issues: CORS misconfiguration blocks frontend,
    Redis connection failures cause documents to hang in processing forever, upload/polling timeouts missing,
    health checks show inaccurate status due to hardcoded LocalStack defaults.
  root_cause: |
    Configuration defaults assume "localhost" for CORS, Redis, and S3. These fail silently in production
    when environment variables are missing or misconfigured. No fail-fast validation at startup.

solution:
  approach: |
    Implement fail-fast validation pattern: detect configuration issues at startup and exit immediately
    with clear error messages instead of allowing silent runtime failures. Add timeout protection and
    error surfacing to frontend.

  files_changed:
    - apps/backend-api/src/config/cors.py: Added fail-fast CORS validation, raises RuntimeError if CORS_ALLOWED_ORIGINS not set in production
    - apps/backend-api/src/main.py: Added CORS error handling, exits on misconfiguration
    - apps/backend-api/src/shared/infrastructure/config.py: Added fail-fast Redis validation, requires REDIS_HOST in production
    - apps/worker-tasks/src/celery_app.py: Added Redis connection test with ping(), exits if unreachable
    - apps/backend-api/src/api/v1/observability.py: Removed hardcoded LocalStack defaults, environment-aware test credentials
    - apps/backend-api/src/shared/storage/s3_service.py: Environment-aware S3 credentials (test creds only in local mode)
    - apps/frontend-web/src/lib/api.ts: Added upload timeouts (2min single, 5min batch) with AbortController
    - apps/frontend-web/src/app/dashboard/documents/page.tsx: Added 5-min polling timeout with error banner and retry
    - apps/frontend-web/src/app/dashboard/documents/batch-review/page.tsx: Added 5-min polling timeout with error UI

validation:
  method: |
    Code review and implementation verification. Testing plan documented for local and production:
    - Local: Set ENVIRONMENT=production, remove CORS/REDIS vars, verify startup fails with clear errors
    - Production: Check logs for startup validation messages, test upload flow end-to-end
  result: pass

impact:
  severity: critical
  systems_affected:
    - Production backend (startup validation)
    - Production worker (Redis connectivity)
    - Production frontend (timeout protection)
    - Health monitoring (accuracy)
  user_impact: |
    Before: Silent failures, infinite spinners, no error feedback
    After: Immediate startup failure with clear errors (backend), timeout errors with retry (frontend)

lessons_learned:
  - Fail-fast is better than fail-silent: Startup validation prevents hours of debugging runtime issues
  - Environment detection is critical: Use ENVIRONMENT variable consistently, detect local vs production behavior
  - Default values are dangerous: Never default to localhost/test values in production-capable code
  - User feedback matters: Infinite spinners are worse than clear error messages with retry options
  - Logging visibility: Startup validation messages must be visible in container logs for debugging
  - Configuration contracts: Missing env.prod.contract.json files allowed misconfiguration to slip through

recommendations:
  - Implement pre-deployment validation (Phase 4 from plan - not yet done)
  - Add /health/detailed endpoint showing actual runtime configuration
  - Create production environment contract files (env.prod.contract.json)
  - Add automated negative testing for fail-fast scenarios
  - Standardize all environment variable detection (use ENVIRONMENT consistently)

tags: [production, silent-failures, fail-fast, cors, redis, timeout, polling, health-checks, configuration-hardening]

related:
  session: SESSION-20251211-production-pipeline-fixes
  commit: 9bf7900
  plan: C:\Users\mylai\.claude\plans\curried-questing-newt.md
  documentation: c:\CREDMATE\TRICIA\golden-path-dev-vs-prod-20251211.md

references:
  - RIS-SESSION-20251128-PROD-CORS-INCIDENT: Related CORS production incident
  - Phase 4 enhancements documented in plan but not implemented (deployment validation framework)
---
