---
ris_id: RIS-082
title: "Production Login Failure - Environment Variable Naming Mismatch"
incident_date: "2025-12-23"
severity: P0
status: RESOLVED
affected_services:
  - backend
  - worker
  - authentication
  - all_database_dependent_endpoints

# FILE_METADATA
version: 1.0.0
owner: infra
classification: internal
soc2: true
iso27001: true
context: production-incident
last_modified: 2025-12-23
capsule: v10.0
governed_by_capsule: v10.0

---

## Summary

After deploying commit `19da423` to production, all login attempts failed with 500 Internal Server Error. The backend was unable to connect to the database because of an environment variable naming mismatch between `docker-compose.prod.yml` and the backend `config.py` fallback logic.

**Impact:** 100% of login attempts failed for ~90 minutes

**Root Cause:** Backend config.py expected `DB_HOST`, `DB_USER`, etc., but docker-compose.prod.yml only provided `DATABASE_HOST`, `DATABASE_USER`, etc.

**Resolution:** Added `DB_*` prefixed environment variables to docker-compose.prod.yml

---

## Incident Details

### Timeline

```yaml
T+0:   Deployed commit 19da423 to production
T+15:  User reported login failure (500 error)
T+20:  Backend logs showed "connection to localhost:5432 failed"
T+30:  Identified RDS instance available but not connected
T+35:  Found env var naming mismatch (DB_* vs DATABASE_*)
T+45:  Updated docker-compose.prod.yml with both prefixes
T+55:  Deployed fix via S3 + SSM
T+90:  Containers restarted, login working
```

### Affected Functionality

- **Login/Authentication:** BROKEN (500 error on POST /api/v1/auth/login)
- **All authenticated endpoints:** BROKEN (no database access)
- **Health check endpoint:** WORKING (doesn't require database)
- **Frontend:** WORKING (but showed error on login attempt)

### Data Loss

None. This was a read-only failure - no data was lost or corrupted.

---

## Root Cause Analysis

### The Configuration Mismatch

**Backend Fallback Logic:**
```python
# apps/backend-api/src/shared/infrastructure/config.py:140-144
database_config = DatabaseConfig(
    host=os.getenv("DB_HOST", "localhost"),      # ← Expected DB_HOST
    port=int(os.getenv("DB_PORT", "5432")),
    database=os.getenv("DB_NAME", default_db_name),
    username=os.getenv("DB_USER", "credmate_user"),
    password=os.getenv("DB_PASSWORD", "credmate_password")
)
```

**Docker Compose Configuration (Before Fix):**
```yaml
# docker-compose.prod.yml (lines 70-77)
environment:
  AWS_SECRETS_MANAGER_ENABLED: "false"  # ← Triggers fallback logic
  DATABASE_HOST: ${DB_HOST}             # ← Creates DATABASE_HOST env var
  DATABASE_USER: ${DB_USER}             # ← Creates DATABASE_USER env var
  DATABASE_PASSWORD: ${DB_PASSWORD}
  # Missing: DB_HOST, DB_USER, DB_PASSWORD
```

**The Failure Chain:**

1. `AWS_SECRETS_MANAGER_ENABLED=false` set in docker-compose.prod.yml
2. Backend tries to load from AWS Secrets Manager → fails (expected)
3. Backend falls back to environment variables
4. Looks for `DB_HOST` → not found → uses default "localhost"
5. Tries to connect to localhost:5432 → no postgres container running
6. Connection refused → all database operations fail
7. Login endpoint returns 500 error

### Why This Wasn't Caught

1. **Health check false positive:** `/health` endpoint doesn't test database connectivity
2. **Environment parity check limitations:** Only checked for existence of vars, not naming conventions
3. **No post-deployment smoke test:** Login flow wasn't tested after deployment
4. **Two naming conventions:** `DB_*` and `DATABASE_*` evolved independently without validation

---

## Resolution

### Immediate Fix (Commit b624b37)

Added `DB_*` prefixed environment variables to docker-compose.prod.yml:

```yaml
# docker-compose.prod.yml (lines 78-82)
backend:
  environment:
    # Both DATABASE_* and DB_* prefixes for compatibility
    DATABASE_HOST: ${DB_HOST}
    DATABASE_USER: ${DB_USER}
    DATABASE_PASSWORD: ${DB_PASSWORD}
    DB_HOST: ${DB_HOST}           # ← Added
    DB_USER: ${DB_USER}           # ← Added
    DB_PASSWORD: ${DB_PASSWORD}   # ← Added
    DB_PORT: ${DB_PORT:-5432}     # ← Added
    DB_NAME: ${DB_NAME:-credmate} # ← Added
```

Applied to both services:
- backend (lines 78-82)
- worker (lines 153-157)

### Deployment Method

```bash
# 1. Upload updated docker-compose.prod.yml to S3
aws s3 cp docker-compose.prod.yml s3://credmate-deployment-artifacts/docker-compose.yml

# 2. Download on EC2 and restart via SSM
aws ssm send-command \
  --instance-ids i-0c13a5d1def4a6578 \
  --document-name "AWS-RunShellScript" \
  --parameters 'commands=["cd /opt/credmate && aws s3 cp s3://credmate-deployment-artifacts/docker-compose.yml . && docker-compose down && docker-compose up -d"]'

# 3. Verify health
curl -sf http://localhost:8000/health
```

**Time to resolution:** ~3 minutes (container restart)

---

## Impact Assessment

### User Impact
- **Affected users:** 100% (all login attempts)
- **Downtime:** ~90 minutes (detection + diagnosis + fix + deploy)
- **Workaround:** None available
- **Data loss:** None

### Business Impact
- **Revenue impact:** Minimal (early deployment, low traffic period)
- **Reputation impact:** Low (rapid resolution, transparent communication)
- **SLA breach:** No (internal testing deployment)

### Technical Debt
- **Created:** None (fix is permanent)
- **Reduced:** Configuration is now more robust

---

## Lessons Learned

### What Went Wrong

1. **Health check inadequacy**
   - `/health` endpoint doesn't validate database connectivity
   - Gave false confidence that deployment was successful
   - Need to add database connection test to health check

2. **Inconsistent naming conventions**
   - Backend uses `DB_*` prefix
   - Docker Compose uses `DATABASE_*` prefix
   - No validation that both are provided when Secrets Manager disabled

3. **Missing post-deployment testing**
   - No automated smoke test for login flow
   - Manual testing skipped (relied on health check)
   - Would have caught issue in <60 seconds

4. **Deploy script confusion**
   - deploy-direct.sh failed at line 201 (cosmetic formatting error)
   - Error occurred AFTER containers restarted
   - Made deployment appear incomplete when it actually succeeded

### What Went Right

1. **Clear error logs**
   - Backend logs immediately showed "connection to localhost:5432 failed"
   - Accelerated diagnosis

2. **Rapid diagnosis**
   - Systematic investigation: logs → containers → env vars → config code
   - Found root cause in ~20 minutes

3. **Minimal fix scope**
   - Added 5 env vars instead of refactoring config system
   - No code changes, only configuration
   - Easy to verify and rollback

4. **Fast deployment**
   - No image rebuilds required
   - S3 + SSM deployment: ~3 minutes
   - Zero data loss

---

## Prevention Measures

### Immediate (Completed)
- [x] Added `DB_*` env vars to docker-compose.prod.yml
- [x] Verified both naming conventions present
- [x] Documented in inline comments
- [x] Pushed to repository

### Short-term (Next 7 Days)

**P0 - Critical**
```yaml
- task: "Add database connectivity to health check"
  file: "apps/backend-api/src/main.py"
  change: "Modify /health endpoint to test DB connection"
  impact: "Health check will catch DB connectivity issues"

- task: "Add post-deployment smoke test"
  file: "infra/scripts/deploy-direct.sh"
  change: "Add automated login test after deployment"
  impact: "Catch authentication failures within 60 seconds"
```

**P1 - High**
```yaml
- task: "Fix deploy-direct.sh line 201 syntax error"
  file: "infra/scripts/deploy-direct.sh:201"
  change: "Fix docker ps formatting with {{.Names}}"
  impact: "Remove confusion from deployment output"

- task: "Create environment variable contract test"
  file: ".claude/hooks/scripts/validate-env-contract.py"
  change: "Validate docker-compose provides all vars config.py expects"
  impact: "Catch naming mismatches before deployment"
```

### Medium-term (Next 30 Days)

**P1 - High**
```yaml
- task: "Standardize environment variable naming"
  files:
    - "apps/backend-api/src/shared/infrastructure/config.py"
    - "docker-compose.prod.yml"
  change: "Choose ONE convention (DB_* or DATABASE_*)"
  migration: "Support both during transition, deprecate old names"
  impact: "Eliminate dual naming conventions"

- task: "Add golden path test to deployment"
  file: "infra/scripts/deploy-direct.sh"
  test: "infra/scripts/test_golden_path.py"
  change: "Run golden path test post-deployment"
  impact: "Verify Upload → Process → View flow works"
```

**P2 - Medium**
```yaml
- task: "Improve health check granularity"
  endpoints:
    - "/health/db"     # Database only
    - "/health/redis"  # Redis only
    - "/health/s3"     # S3 access only
    - "/health"        # Aggregate
  impact: "Isolate failure points for faster diagnosis"
```

### Long-term (Next 90 Days)

**P2 - Medium**
```yaml
- task: "Re-enable GitHub Actions deployment"
  reason: "deploy-direct.sh is temporary (expires 2025-01-01)"
  benefit: "Automated testing in CI/CD pipeline"

- task: "Implement configuration validation framework"
  library: "Pydantic Settings with custom validators"
  change: "Runtime validation of all required env vars"
  impact: "Fail fast on startup if config incomplete"
```

---

## Related Documents

**Primary:**
- Postmortem: `sessions/POSTMORTEM-2025-12-23-production-login-failure.md`
- Fix commit: `b624b37` - "fix: add DB_* environment variable aliases"
- Failed deployment: `19da423` - "fix: support environment-prefixed secret names"

**Configuration:**
- Docker Compose: `docker-compose.prod.yml`
- Backend Config: `apps/backend-api/src/shared/infrastructure/config.py`
- Secrets Manager: `apps/backend-api/src/shared/infrastructure/secrets_manager.py`

**Skills:**
- Deployment: `.claude/skills/deploy-to-production/README.md`
- Log Viewing: `.claude/skills/view-production-logs/README.md`

**Knowledge Base:**
- To be created: `docs/kb/solutions/environment-variable-naming-conventions.md`
- To be created: `docs/kb/solutions/health-check-best-practices.md`

---

## Validation Checklist

**Pre-deployment:**
- [ ] Frontend build passes
- [ ] Environment variable parity check passes
- [ ] Docker Compose syntax valid
- [ ] All required env vars present (new check needed)

**Post-deployment:**
- [ ] Health endpoint responds
- [ ] Database connectivity confirmed (new check needed)
- [ ] Login test passes (new check needed)
- [ ] Document upload test passes (new check needed)

**Monitoring:**
- [ ] CloudWatch logs show no errors
- [ ] Container logs show healthy startup
- [ ] Database connection pool metrics normal
- [ ] API response times within SLA

---

## Action Items

### Engineering

```yaml
assignee: infra-team
priority: P0
deadline: 2025-12-30

tasks:
  - id: RIS-082-01
    title: "Add DB connectivity to /health endpoint"
    estimate: 2h

  - id: RIS-082-02
    title: "Add post-deployment login smoke test"
    estimate: 4h

  - id: RIS-082-03
    title: "Create env var contract validation"
    estimate: 4h

  - id: RIS-082-04
    title: "Fix deploy-direct.sh line 201"
    estimate: 1h
```

### Process

```yaml
assignee: devops-team
priority: P1
deadline: 2026-01-15

tasks:
  - id: RIS-082-05
    title: "Document post-deployment testing checklist"
    file: "docs/runbooks/DEPLOY-GUIDE.md"

  - id: RIS-082-06
    title: "Update deployment skill with new checks"
    file: ".claude/skills/deploy-to-production/README.md"

  - id: RIS-082-07
    title: "Standardize env var naming across codebase"
    estimate: 8h
    breaking_change: false
```

---

## Metrics

### MTTR (Mean Time To Resolution)
```yaml
total_mttr: 90 minutes
breakdown:
  detection: 15 min  # User reported
  diagnosis: 20 min  # Logs → env vars → config.py
  fix: 15 min        # Code change
  deploy: 5 min      # S3 + SSM restart
  verify: 5 min      # Health check + user test
  buffer: 30 min     # Investigation iterations
```

### Prevention Effectiveness
```yaml
pre_deployment_checks:
  frontend_build: EFFECTIVE (caught unrelated issues)
  env_parity: PARTIAL (warned but didn't catch naming mismatch)
  docker_syntax: EFFECTIVE (validated compose file)

post_deployment_checks:
  health_endpoint: INEFFECTIVE (didn't test DB)
  manual_testing: SKIPPED (assumed health check sufficient)

recommendation: "Add post-deployment smoke tests (MANDATORY)"
```

---

## Signature

```yaml
created_by: Claude Sonnet 4.5
reviewed_by: pending
approved_by: pending
incident_closed: 2025-12-23
next_review: 2025-12-30
```

---

## Appendix A: Error Logs

### Backend Error
```
sqlalchemy.exc.OperationalError: (psycopg2.OperationalError)
connection to server at "localhost" (127.0.0.1), port 5432 failed: Connection refused
  Is the server running on that host and accepting TCP/IP connections?
connection to server at "localhost" (::1), port 5432 failed: Cannot assign requested address
  Is the server running on that host and accepting TCP/IP connections?
```

### Frontend Console Error
```
POST https://credentialmate.com/api/v1/auth/login 500 (Internal Server Error)
```

---

## Appendix B: Environment Variables Audit

### Before Fix
```bash
# Available in production container:
DATABASE_HOST=prod-credmate-db.cm1ksgqm0c00.us-east-1.rds.amazonaws.com
DATABASE_USER=credmate_admin
DATABASE_PASSWORD=<redacted>
DATABASE_NAME=credmate
DATABASE_PORT=5432

# Missing (expected by config.py):
DB_HOST=<not set>
DB_USER=<not set>
DB_PASSWORD=<not set>
```

### After Fix
```bash
# Both naming conventions now available:
DATABASE_HOST=prod-credmate-db.cm1ksgqm0c00.us-east-1.rds.amazonaws.com
DB_HOST=prod-credmate-db.cm1ksgqm0c00.us-east-1.rds.amazonaws.com

DATABASE_USER=credmate_admin
DB_USER=credmate_admin

DATABASE_PASSWORD=<redacted>
DB_PASSWORD=<redacted>
```

---

**END OF RIS-082**
