---
ris_id: RIS-048
title: "Document Upload 500 Error - Enum Case Mismatch"
status: RESOLVED
severity: CRITICAL
category: BUG_FIX
date_reported: "2025-12-13"
date_resolved: "2025-12-13"
reported_by: "Pre-commit Golden Path Test"
resolved_by: "Claude Code"

# IMPACT
impact:
  description: "All document uploads failing with 500 Internal Server Error"
  affected_components:
    - "Document upload endpoint (POST /api/v1/documents/upload)"
    - "Batch document upload"
    - "Onboarding flow"
    - "Golden path test (blocking commits)"
  affected_users:
    - "All users attempting to upload documents"
    - "Developers (commits blocked by pre-commit hook)"
  business_impact: "CRITICAL - Complete inability to upload documents"

# ROOT CAUSE
root_cause:
  summary: "Database enum constraint violation due to case mismatch"
  technical_details: |
    Python enum `DocumentDataSource` defined values as lowercase:
    - AI = "ai"
    - HUMAN = "human"

    PostgreSQL enum type `documentdatasource` expected uppercase:
    - AI
    - HUMAN

    When the upload endpoint attempted to insert a new document record,
    SQLAlchemy passed lowercase "ai" to the database, which rejected it
    with a LookupError constraint violation.

  failure_point: "apps/backend-api/src/api/v1/documents.py:364"
  error_message: |
    LookupError: 'ai' is not among the defined enum values.
    Enum name: documentdatasource.
    Possible values: AI, HUMAN

# INVESTIGATION
investigation:
  steps_taken:
    - "Ran golden path test manually to reproduce error"
    - "Checked backend logs for 500 error details"
    - "Examined document upload endpoint code flow"
    - "Verified database enum constraint definition"
    - "Checked existing data for lowercase values (none found)"
    - "Searched codebase for hardcoded lowercase comparisons (none found)"

  findings:
    - "Database already contained 61 documents with uppercase values (AI: 45, HUMAN: 16)"
    - "No data migration needed"
    - "Only Python enum definition needed correction"
    - "No frontend TypeScript enum definitions exist"
    - "No API schema changes required"

# RESOLUTION
resolution:
  summary: "Updated Python enum values to match database constraint (uppercase)"

  changes:
    - file: "apps/backend-api/src/contexts/documents/models/document.py"
      lines: "53-54"
      change: |
        Changed enum values from lowercase to uppercase:
        - AI = "ai"      →  AI = "AI"
        - HUMAN = "human"  →  HUMAN = "HUMAN"

  testing:
    - "Verified no existing lowercase data in database"
    - "Checked for hardcoded lowercase string comparisons (none found)"
    - "Restarted backend and worker services"
    - "Ran golden path test - ALL STEPS PASSED"
    - "Verified new document has data_source='AI' (uppercase) in database"

  validation:
    golden_path_result: "PASSED"
    steps_validated:
      - "✅ Health checks"
      - "✅ Authentication"
      - "✅ Document upload (201 Created)"
      - "✅ Worker processing"
      - "✅ Extraction results"
      - "✅ View endpoint"

# PREVENTION
prevention:
  immediate:
    - "Enum values now match database constraints"
    - "Golden path test will catch similar issues in future"

  long_term:
    - action: "Add enum validation to Alembic migration template"
      description: "Ensure enum values in code match database constraints"
      priority: "MEDIUM"

    - action: "Add pre-commit check for enum consistency"
      description: "Validate Python enums match database enum types"
      priority: "LOW"

    - action: "Document enum conventions in CLAUDE.md"
      description: "Specify that PostgreSQL enums use uppercase by convention"
      priority: "LOW"

# RELATED ISSUES
related_issues:
  - id: "SESSION-20251213-1805-cme-data-audit-investigation"
    relationship: "UNRELATED"
    description: |
      That session identified CME data completeness issues (missing cycles,
      NULL topics, NULL states) which are separate from this upload bug.
      Those issues require follow-up fixes but did not cause this 500 error.

# METRICS
metrics:
  time_to_detect: "Immediate (pre-commit hook)"
  time_to_diagnose: "15 minutes"
  time_to_fix: "5 minutes"
  time_to_validate: "5 minutes"
  total_resolution_time: "25 minutes"

  affected_period:
    start: "Unknown (likely since database migration created enum)"
    end: "2025-12-13 (immediate fix)"

  data_integrity:
    data_loss: "NONE"
    data_migration_required: false
    existing_records_affected: 0

# LESSONS LEARNED
lessons_learned:
  what_went_well:
    - "Golden path pre-commit hook caught the issue before production"
    - "Clear error message from PostgreSQL pointed directly to enum mismatch"
    - "No data migration needed (database already had correct values)"
    - "Quick diagnosis and fix (25 minutes total)"

  what_could_improve:
    - "Should validate enum values match database during migration creation"
    - "Could add type-level validation between Python and SQL enums"

  action_items:
    - "Add enum validation to migration review checklist"
    - "Consider adding database constraint validation to unit tests"

# APPROVAL
approved_by: "Claude Code"
approval_date: "2025-12-13"
review_notes: |
  Fix validated with:
  - Full golden path test pass
  - Database verification of uppercase values
  - Codebase search for hardcoded strings
  - Service restart and smoke test

  No rollback needed. Low regression risk.
