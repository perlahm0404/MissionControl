---
id: RIS-RESOLUTION-035
title: Worker Syntax Error - Try Block Indentation
status: RESOLVED
severity: CRITICAL
created: 2025-12-09
resolved: 2025-12-09
session: SESSION-20251209-1900-pain-clinic-practitioner-field
tags:
  - worker
  - celery
  - syntax-error
  - container
  - docker
---

# RIS-RESOLUTION-035: Worker Syntax Error - Try Block Indentation

## Summary

Worker container was in a continuous restart loop due to a Python syntax error where an import statement was not properly indented inside a try block.

## Severity

**CRITICAL** - All document processing was completely broken. Worker could not start.

## Symptoms

- `docker compose ps` showed worker container status as "Restarting (1) Less than a second ago"
- Worker logs showed: `SyntaxError: expected 'except' or 'finally' block`
- Error pointed to line 94 of `process_document_task.py`

## Root Cause

In `apps/worker-tasks/src/tasks/document_processing/process_document_task.py`, an import statement was NOT indented inside a `try` block, breaking Python's try/except syntax.

### Broken Code (Lines 87-94)

```python
try:
    from apps.shared.enums.document import (
        DocumentStatus,
        is_supported_document_type,
        get_unsupported_type_message,
        SUPPORTED_DOCUMENT_TYPES
    )
from shared.storage.s3_service import S3Service, S3ObjectNotFoundError  # <-- NOT INDENTED!
    # NOTE: log_event removed...
except ImportError as e:
```

The `from shared.storage...` line was at column 0 instead of being indented to be inside the try block. Python saw this as ending the try block without an except clause.

## Resolution

Added proper 4-space indentation to the import statement:

### Fixed Code

```python
try:
    from apps.shared.enums.document import (
        DocumentStatus,
        is_supported_document_type,
        get_unsupported_type_message,
        SUPPORTED_DOCUMENT_TYPES
    )
    from shared.storage.s3_service import S3Service, S3ObjectNotFoundError  # Now indented
    # NOTE: log_event removed...
except ImportError as e:
```

## Steps to Reproduce (Before Fix)

1. Start containers with `docker compose up -d`
2. Worker container enters restart loop
3. `docker compose logs worker --tail 30` shows syntax error

## Verification Steps (After Fix)

1. Edit `process_document_task.py` to fix indentation
2. Rebuild worker: `docker compose up -d --build worker`
3. Verify worker running: `docker compose ps` shows healthy status
4. Verify logs: `docker compose logs worker --tail 10` shows normal startup

## Impact

- **Before Fix**: ALL document processing broken, worker could not start
- **After Fix**: Worker starts normally, document processing operational

## Prevention

1. **Linting**: Enable flake8/pylint in CI to catch syntax errors before merge
2. **Pre-commit Hooks**: Add Python syntax validation to pre-commit
3. **Container Health Checks**: Worker container should have health check that fails fast on import errors

## Related Files

- `apps/worker-tasks/src/tasks/document_processing/process_document_task.py` (line 94)

## Debugging Commands Used

```bash
# Check container status
docker compose ps

# View worker logs (key diagnostic)
docker compose logs worker --tail 50

# Rebuild single service
docker compose up -d --build worker
```

## Lessons Learned

1. Always check `docker compose logs <service>` when container is in restart loop
2. Python syntax errors in import blocks often manifest as "expected except" errors
3. After editing worker code, must rebuild container (not just restart) since code is copied during build
