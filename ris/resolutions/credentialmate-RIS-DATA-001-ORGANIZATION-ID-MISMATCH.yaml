# RIS: Organization ID Mismatch Data Integrity Issue
# Severity: HIGH
# Status: RESOLVED
# Date: 2025-12-27

metadata:
  id: RIS-DATA-001
  title: "Organization ID Mismatch Causes Zero Data Display"
  category: data-integrity
  severity: high
  status: resolved
  created: 2025-12-27
  resolved: 2025-12-27
  author: claude-code

summary: |
  User data (licenses, documents) not displaying in production UI despite existing
  in database. Root cause was organization_id mismatch - data inserted with wrong
  organization_id causing API filters to exclude records.

symptoms:
  - Dashboard shows "0 licenses" for user with 12 licenses
  - "No state licenses found" message despite populated data
  - Documents pending review visible but count incorrect
  - API returns empty arrays for user's credentials

root_cause: |
  Data was inserted with organization_id = 1001 (matching provider_id) instead of
  organization_id = 1 (the user's actual organization). The API filters all queries
  by the authenticated user's organization_id, so mismatched records become invisible.

  Affected tables:
  - licenses: 12 records with wrong org_id
  - documents: 7 records with wrong org_id

diagnosis_steps:
  - step: 1
    action: "Query user record"
    command: |
      SELECT u.id, u.email, u.provider_id, u.organization_id
      FROM users u WHERE u.email = 'real1@test.com'
    result: "user organization_id = 1"

  - step: 2
    action: "Query license records"
    command: |
      SELECT l.id, l.state, l.organization_id
      FROM licenses l WHERE l.provider_id = 1001 LIMIT 5
    result: "licenses organization_id = 1001 (MISMATCH)"

  - step: 3
    action: "Confirm provider organization"
    command: |
      SELECT p.id, p.organization_id
      FROM providers p WHERE p.id = 1001
    result: "provider organization_id = 1"

resolution:
  immediate:
    - description: "Fix licenses organization_id"
      sql: |
        UPDATE licenses
        SET organization_id = 1
        WHERE provider_id = 1001 AND organization_id = 1001
      result: "12 rows affected"

    - description: "Fix documents organization_id"
      sql: |
        UPDATE documents
        SET organization_id = 1
        WHERE provider_id = 1001 AND organization_id = 1001
      result: "7 rows affected"

  execution_method: |
    Via prod_ops_common.py exec_in_container:
    python3 -c "import os; from sqlalchemy import create_engine, text;
    engine = create_engine(os.environ['DATABASE_URL']);
    conn = engine.connect();
    result = conn.execute(text('UPDATE ...'));
    conn.commit()"

prevention:
  - action: "Add organization_id validation to seed scripts"
    priority: high
    description: |
      Ensure all insert operations derive organization_id from the user/provider
      relationship, not from provider_id or other fields.

  - action: "Add data integrity check to bulk import"
    priority: high
    description: |
      Post-import validation query to detect organization_id mismatches:
      SELECT 'licenses' as tbl, COUNT(*) FROM licenses l
      JOIN providers p ON l.provider_id = p.id
      WHERE l.organization_id != p.organization_id

  - action: "Add foreign key constraint consideration"
    priority: medium
    description: |
      Consider adding CHECK constraint or trigger to ensure
      licenses.organization_id matches providers.organization_id

detection:
  query: |
    -- Detect organization_id mismatches across tables
    SELECT 'licenses' as table_name, COUNT(*) as mismatch_count
    FROM licenses l
    JOIN providers p ON l.provider_id = p.id
    WHERE l.organization_id != p.organization_id
    UNION ALL
    SELECT 'documents', COUNT(*)
    FROM documents d
    JOIN providers p ON d.provider_id = p.id
    WHERE d.organization_id != p.organization_id

  expected: "All counts should be 0"

related_issues:
  - "CloudFront cache causing Server Action errors (separate fix)"
  - "Frontend health check failing due to missing curl (cosmetic)"

lessons_learned:
  - "Multi-tenant filtering makes mismatched data invisible, not errored"
  - "Always verify organization_id consistency after bulk imports"
  - "Symptoms can appear as 'no data' when data exists but is filtered out"
  - "Query raw database to diagnose UI data display issues"

tags:
  - data-integrity
  - multi-tenant
  - organization-id
  - production-fix
