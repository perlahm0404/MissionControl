# RIS-RESOLUTION-069: Dashboard 500 Error from Tuple Unpacking Mismatch
# Date: 2025-12-14
# Severity: HIGH
# Status: RESOLVED

incident:
  id: RIS-RESOLUTION-069
  title: "Dashboard 500 Error from Tuple Unpacking Mismatch"
  date: "2025-12-14"
  severity: HIGH
  status: RESOLVED

  summary: |
    Dashboard page showed "Getting Started" onboarding screen instead of actual dashboard.
    Browser console showed CORS errors, but actual root cause was 500 Internal Server Error
    from /api/v1/dashboard/overview endpoint due to tuple unpacking mismatch.

  timeline:
    - time: "2025-12-14 Earlier"
      event: "Modified get_portfolio_credentials() to return 7-value tuples (added state and number fields)"
      actor: "Developer"

    - time: "2025-12-14 Later"
      event: "User reports dashboard showing 'Getting Started' page instead of actual dashboard"
      actor: "User (real100@test.com)"

    - time: "2025-12-14 Investigation"
      event: "Browser console shows CORS errors for /api/v1/dashboard/overview"
      actor: "Claude"

    - time: "2025-12-14 Investigation"
      event: "Checked CORS configuration - all correct"
      actor: "Claude"

    - time: "2025-12-14 Root Cause"
      event: "Backend logs show 'ValueError: too many values to unpack (expected 5)' at line 350"
      actor: "Claude"

    - time: "2025-12-14 Fix"
      event: "Updated get_dashboard_overview() to unpack 7 values instead of 5"
      actor: "Claude"
      files:
        - apps/backend-api/src/contexts/dashboard/api/dashboard_endpoints.py:350

root_cause:
  description: |
    The get_portfolio_credentials() function was modified to return 7-value tuples:
    (item_type, item_id, title, expires_at, provider_name, state, number)

    This change was made to support the UpcomingRenewalsTimeline component which needs
    state and number fields to display credential information.

    However, the get_dashboard_overview() endpoint still unpacked only 5 values:
    for item_type, item_id, title, expires_at, provider_name in credentials:

    Python raised ValueError when trying to unpack 7 values into 5 variables.

  symptom_misleading: |
    Browser showed CORS errors, which was misleading. This happens because:
    1. Frontend makes request to http://localhost:8000/api/v1/dashboard/overview
    2. Backend returns 500 Internal Server Error
    3. Browser security policy prevents exposing error details for cross-origin failed requests
    4. Browser console shows "blocked by CORS policy" instead of the real 500 error

    LESSON: CORS errors in browser console may actually be 500 errors from backend.
    Always check backend logs when investigating CORS issues.

  files_affected:
    - file: apps/backend-api/src/contexts/dashboard/api/dashboard_endpoints.py
      line: 350
      issue: "Unpacking 5 values from 7-value tuple"

    - file: apps/backend-api/src/contexts/dashboard/api/dashboard_endpoints.py
      line: 233-266
      issue: "get_portfolio_credentials() returns 7-value tuples"

resolution:
  changes:
    - file: apps/backend-api/src/contexts/dashboard/api/dashboard_endpoints.py
      line: 350
      change: |
        OLD: for item_type, item_id, title, expires_at, provider_name in credentials:
        NEW: for item_type, item_id, title, expires_at, provider_name, state, number in credentials:

  verification:
    - "Restarted backend container"
    - "Dashboard page loads correctly"
    - "/api/v1/dashboard/overview returns 200 OK"
    - "User can see full dashboard with credentials"

prevention:
  immediate:
    - type: "Code Review"
      action: "When modifying tuple return values, search for all unpacking sites"

    - type: "Testing"
      action: "Test all dashboard endpoints after schema changes"

  long_term:
    - type: "Architecture"
      action: "Replace positional tuples with TypedDict or dataclass"
      rationale: |
        Positional tuples are fragile - adding/removing fields breaks all unpacking sites.
        TypedDict or dataclass provides named access and type safety.

    - type: "Testing"
      action: "Add integration test that calls all dashboard endpoints"
      rationale: "Would have caught this immediately"

lessons_learned:
  - lesson: "CORS errors in browser console may actually be 500 errors from backend"
    action: "Always check backend logs first when investigating CORS issues"

  - lesson: "Positional tuple unpacking is fragile and error-prone"
    action: "Prefer TypedDict or dataclass for multi-field return values"

  - lesson: "Schema changes propagate through multiple layers"
    action: "When changing return types, grep for all usage sites"

impact:
  severity: HIGH
  user_impact: "Dashboard unusable - shows onboarding screen instead of credentials"
  duration: "~30 minutes"
  affected_users: "All users trying to access dashboard"
  data_loss: "None"

related_incidents:
  - "RIS-RESOLUTION-028: License lifecycle management UX improvements"
  - "Earlier in same session: Added license_type field to credentials"

metadata:
  resolution_time: "30 minutes"
  investigation_time: "20 minutes"
  fix_time: "5 minutes"
  verification_time: "5 minutes"

tags:
  - backend
  - dashboard
  - tuple-unpacking
  - python
  - 500-error
  - cors-misleading
  - schema-change
